<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>لعبة المحقق (المخادع)</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Courier+Prime:wght@400;700&family=Tajawal:wght@400;700;900&display=swap" rel="stylesheet">

    <style>
        /* --- GLOBAL STYLES & NOIR THEME --- */
        :root {
            --bg-color: #121212;
            --paper-color: #f0e6d2;
            --ink-color: #1a1a1a;
            --accent-red: #8b0000;
            --accent-gold: #d4c5a5;
        }

        body {
            font-family: 'Tajawal', sans-serif;
            background-color: var(--bg-color);
            color: #e0e0e0;
            overflow: hidden; /* Prevent scrolling on body */
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        .font-typewriter {
            font-family: 'Courier Prime', monospace, 'Tajawal', sans-serif;
        }

        /* --- ANIMATIONS --- */
        @keyframes grain {
            0%, 100% { transform: translate(0, 0); }
            10% { transform: translate(-5%, -10%); }
            20% { transform: translate(-15%, 5%); }
            30% { transform: translate(7%, -25%); }
            40% { transform: translate(-5%, 25%); }
            50% { transform: translate(-15%, 10%); }
            60% { transform: translate(15%, 0%); }
            70% { transform: translate(0%, 15%); }
            80% { transform: translate(3%, 35%); }
            90% { transform: translate(-10%, 10%); }
        }

        .film-grain {
            position: fixed;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background-image: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI1MTIiIGhlaWdodD0iNTEyIj48ZmlsdGVyIGlkPSJnoiPjxmZVR1cmJ1bGVuY2UgdHlwZT0iZnJhY3RhbE5vaXNlIiBiYXNlRnJlcXVlbmN5PSIwLjY1IiBudW1PY3RhdmVzPSIzIiBzdGl0Y2hUaWxlcz0ic3RpdGNoIi8+PC9maWx0ZXI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsdGVyPSJ1cmwoI2cpIiBvcGFjaXR5PSIwLjUiLz48L3N2Zz4=');
            opacity: 0.05;
            animation: grain 8s steps(10) infinite;
            pointer-events: none;
            z-index: 0;
        }

        @keyframes flicker {
            0% { opacity: 0.95; }
            5% { opacity: 0.85; }
            10% { opacity: 0.95; }
            15% { opacity: 0.75; }
            20% { opacity: 0.95; }
            50% { opacity: 0.95; }
            55% { opacity: 0.85; }
            60% { opacity: 0.95; }
            100% { opacity: 0.95; }
        }

        .light-flicker {
            position: fixed;
            inset: 0;
            background: radial-gradient(circle at 50% 30%, rgba(255, 255, 220, 0.05), transparent 70%);
            animation: flicker 6s infinite;
            pointer-events: none;
            z-index: 1;
        }

        @keyframes stamp-in {
            0% { opacity: 0; transform: scale(2) rotate(-10deg); }
            100% { opacity: 1; transform: scale(1) rotate(-2deg); }
        }

        .stamp-animation {
            animation: stamp-in 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }

        @keyframes slide-up {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .animate-slide-up {
            animation: slide-up 0.5s ease-out forwards;
        }

        /* --- UI ELEMENTS --- */
        .noir-btn {
            position: relative;
            font-family: 'Courier Prime', monospace;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            padding: 12px 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            border: 2px solid black;
            transition: all 0.1s;
            cursor: pointer;
            overflow: hidden;
        }
        
        .noir-btn:active {
            transform: translateY(2px);
            box-shadow: none !important;
        }

        .btn-primary {
            background-color: var(--ink-color);
            color: var(--paper-color);
            box-shadow: 4px 4px 0px var(--accent-red);
        }
        
        .btn-secondary {
            background-color: var(--paper-color);
            color: var(--ink-color);
            border-style: dashed;
            box-shadow: 4px 4px 0px rgba(0,0,0,0.5);
        }

        .btn-danger {
            background-color: var(--accent-red);
            color: var(--paper-color);
            box-shadow: 4px 4px 0px black;
        }

        .case-file {
            background-color: var(--paper-color);
            background-image: url('https://www.transparenttextures.com/patterns/paper.png');
            color: var(--ink-color);
            padding: 24px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            position: relative;
        }

        .case-file::before {
            content: '';
            position: absolute;
            inset: 0;
            background-image: url('https://www.transparenttextures.com/patterns/notebook.png');
            opacity: 0.1;
            pointer-events: none;
        }

        .case-folder {
            border-top: 8px solid var(--accent-gold);
            border-radius: 0 40px 0 0;
        }

        .paper-clip {
            position: absolute;
            top: -12px;
            left: 50%;
            transform: translateX(-50%);
            width: 20px;
            height: 50px;
            border: 4px solid #999;
            border-radius: 20px;
            z-index: 10;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: #1a1a1a; }
        ::-webkit-scrollbar-thumb { background: #555; }

        .hidden { display: none !important; }
        
        /* Input Focus Ring */
        input:focus {
            outline: none;
            border-color: var(--paper-color);
            background-color: #222;
        }

    </style>
</head>
<body>

    <!-- Effects Layers -->
    <div class="film-grain"></div>
    <div class="light-flicker"></div>

    <div class="relative z-10 w-full max-w-md mx-auto h-screen flex flex-col bg-[#0a0a0a] border-x border-[#333] shadow-2xl">
        
        <!-- Header -->
        <header class="px-6 py-4 flex justify-between items-center z-20 border-b border-[#333] bg-[#0f0f0f] shadow-lg shrink-0">
            <div class="flex items-center gap-3">
                <div class="p-2 border-2 border-[#f0e6d2] rounded-full shadow-[0_0_10px_rgba(240,230,210,0.1)]">
                    <i data-lucide="fingerprint" class="text-[#f0e6d2] w-6 h-6"></i>
                </div>
                <div>
                    <h1 class="font-typewriter font-bold text-xl tracking-widest text-[#f0e6d2] drop-shadow-md">المخادع</h1>
                    <p class="text-[10px] text-gray-500 font-typewriter tracking-wider uppercase flex items-center gap-1">
                        <span class="w-2 h-2 bg-red-900 rounded-full animate-pulse"></span>
                        تحقيق جاري
                    </p>
                </div>
            </div>
            
            <div class="flex gap-2">
                <button onclick="showRules()" class="p-2 text-[#f0e6d2] hover:bg-white/5 rounded transition"><i data-lucide="help-circle"></i></button>
                <button onclick="resetGame()" id="resetBtn" class="p-2 text-[#f0e6d2] hover:bg-white/5 rounded transition hidden"><i data-lucide="refresh-cw"></i></button>
            </div>
        </header>

        <!-- Main Content Area -->
        <main id="app" class="flex-1 overflow-y-auto p-6 relative flex flex-col">
            <!-- Content will be injected here via JavaScript -->
        </main>

    </div>

    <!-- Rules Modal (Hidden by default) -->
    <div id="rulesModal" class="fixed inset-0 z-50 bg-black/95 flex items-center justify-center p-4 hidden animate-slide-up">
        <div class="case-file w-full max-w-sm transform rotate-1">
            <div class="paper-clip"></div>
            <div class="absolute -top-6 left-0 bg-black text-white px-4 py-1 text-xs font-typewriter -rotate-1 shadow-[2px_2px_0px_#8b0000]">
                دليل الإجراءات
            </div>
            
            <div class="space-y-6 text-sm font-typewriter mt-4">
                <div class="flex gap-4 items-start">
                    <span class="bg-black text-white w-6 h-6 flex items-center justify-center text-xs shrink-0 font-bold">1</span>
                    <div>
                        <p class="font-bold mb-1">توزيع الأدوار</p>
                        <p class="text-xs text-gray-600">مرر الملف لكل محقق. واحد فقط هو الجاسوس (المخادع).</p>
                    </div>
                </div>
                <div class="flex gap-4 items-start">
                    <span class="bg-black text-white w-6 h-6 flex items-center justify-center text-xs shrink-0 font-bold">2</span>
                    <div>
                        <p class="font-bold mb-1">الاستجواب</p>
                        <p class="text-xs text-gray-600">اطرحوا أسئلة ملتوية. حاولوا كشف الجاسوس دون فضح الكلمة.</p>
                    </div>
                </div>
                <div class="flex gap-4 items-start">
                    <span class="bg-black text-white w-6 h-6 flex items-center justify-center text-xs shrink-0 font-bold">3</span>
                    <div>
                        <p class="font-bold mb-1">الحكم</p>
                        <p class="text-xs text-gray-600">صوتوا للقبض على الجاسوس قبل نفاد الوقت.</p>
                    </div>
                </div>
            </div>
            <div class="mt-8">
                <button onclick="closeRules()" class="noir-btn btn-secondary w-full">علم، وسينفذ</button>
            </div>
        </div>
    </div>

    <script>
        // --- DATA ---
        const CATEGORIES = {
            'حيوانات': ['أسد', 'فيل', 'زرافة', 'نمر', 'قطة', 'كلب', 'حوت', 'صقر', 'تمساح', 'بطريق', 'كنغر', 'دب', 'حصان', 'ذئب', 'ثعلب'],
            'أكلات': ['بيتزا', 'كبسة', 'برجر', 'سوشي', 'شاورما', 'مكرونة', 'فلافل', 'منسف', 'مسخن', 'كشري', 'دجاج مقلي', 'ستيك', 'ملوخية', 'محاشي'],
            'أدوات': ['مطرقة', 'مفك', 'منشار', 'قلم', 'هاتف', 'لابتوب', 'مقص', 'فرشاة', 'ملعقة', 'نظارة', 'ساعة', 'مفتاح', 'سماعة', 'شاحن'],
            'أماكن': ['مدرسة', 'مستشفى', 'مطار', 'ملعب', 'سينما', 'حديقة', 'مطعم', 'مكتبة', 'سجن', 'فندق', 'محطة قطار', 'شاطئ', 'مقهى', 'مسجد'],
            'وظائف': ['طبيب', 'مهندس', 'معلم', 'شرطي', 'طيار', 'طباخ', 'نجار', 'رسام', 'محامي', 'ممرض', 'رائد فضاء', 'حلاق', 'ميكانيكي', 'خباز'],
            'ماركات': ['تويوتا', 'آيفون', 'نايك', 'بيبسي', 'ماكدونالدز', 'سامسونج', 'مرسيدس', 'أديداس', 'جوجل', 'زارا', 'روليكس', 'سوني'],
            'دول': ['مصر', 'السعودية', 'الإمارات', 'المغرب', 'فرنسا', 'إيطاليا', 'اليابان', 'الصين', 'البرازيل', 'تركيا', 'ألمانيا', 'أمريكا'],
            'عشوائي': [] // Placeholder
        };

        // --- STATE ---
        let state = {
            screen: 'setup', // setup, category, custom, pass-phone, playing, voting, result
            players: ['المشتبه 1', 'المشتبه 2', 'المشتبه 3'],
            selectedCategory: null,
            secretWord: '',
            imposterIndex: null,
            firstPlayerIndex: null,
            currentPlayerIndex: 0,
            timer: 0,
            timerInterval: null,
            winner: null
        };

        // --- RENDER FUNCTION ---
        function render() {
            const app = document.getElementById('app');
            const resetBtn = document.getElementById('resetBtn');
            app.innerHTML = '';
            
            // Show/Hide Reset Button
            if (state.screen === 'setup') resetBtn.classList.add('hidden');
            else resetBtn.classList.remove('hidden');

            // Render based on screen
            switch(state.screen) {
                case 'setup': renderSetup(app); break;
                case 'category': renderCategory(app); break;
                case 'custom': renderCustom(app); break;
                case 'pass-phone': renderPassPhone(app); break;
                case 'playing': renderPlaying(app); break;
                case 'voting': renderVoting(app); break;
                case 'result': renderResult(app); break;
            }
            
            // Re-initialize icons
            lucide.createIcons();
        }

        // --- SCREENS ---

        function renderSetup(container) {
            let playersListHtml = state.players.map((p, i) => `
                <div class="flex items-center justify-between p-3 bg-[#f0e6d2] text-black shadow-md border-l-4 border-[#8b0000] transform hover:translate-x-1 transition-transform cursor-default" style="background-image: url('https://www.transparenttextures.com/patterns/paper.png');">
                    <div class="flex items-center gap-4">
                        <span class="font-typewriter font-bold text-xs text-[#8b0000] opacity-50">#${(i+1).toString().padStart(3, '0')}</span>
                        <span class="font-typewriter font-bold text-lg tracking-wide">${p}</span>
                    </div>
                    <button onclick="removePlayer(${i})" class="text-[#8b0000] hover:bg-[#8b0000] hover:text-[#f0e6d2] rounded p-1 transition-colors"><i data-lucide="x" class="w-4 h-4"></i></button>
                </div>
            `).join('');

            container.innerHTML = `
                <div class="flex flex-col gap-6 animate-slide-up pb-10 h-full">
                    
                    <!-- Leaderboard Tape -->
                    <div class="bg-[#1a1a1a] border border-[#333] p-1 shadow-inner relative mt-2">
                        <div class="absolute -top-3 left-1/2 -translate-x-1/2 w-24 h-6 bg-[#ffffff20] -rotate-1 blur-[1px]"></div>
                        <div class="bg-[#111] p-4 border border-[#333]">
                            <div class="flex justify-between items-center mb-1 border-b border-[#333] pb-1">
                                <span class="text-[10px] text-[#8b0000] font-typewriter uppercase tracking-widest font-bold">عدد المشتبهين الحالي</span>
                                <span class="text-[#f0e6d2] font-bold">${state.players.length}</span>
                            </div>
                        </div>
                    </div>

                    <!-- Add Player -->
                    <div class="flex-1 flex flex-col gap-4">
                        <div class="flex flex-col gap-2">
                            <label class="text-[10px] text-gray-500 font-typewriter uppercase tracking-widest ml-1">>> إضافة مشتبه به جديد:</label>
                            <div class="flex relative shadow-lg">
                                <input type="text" id="newPlayerInput" placeholder="الاسم..." class="flex-1 bg-[#1a1a1a] border-2 border-[#333] p-4 font-typewriter text-[#f0e6d2] transition-all" onkeypress="handleEnter(event)">
                                <button onclick="addPlayer()" class="bg-[#f0e6d2] text-black px-6 font-bold border-2 border-[#f0e6d2] hover:bg-white transition-colors flex items-center justify-center">
                                    <i data-lucide="plus" class="w-6 h-6"></i>
                                </button>
                            </div>
                        </div>

                        <div class="flex-1 overflow-y-auto space-y-2 pr-1 custom-scrollbar">
                            ${state.players.length ? playersListHtml : '<div class="text-center py-10 text-gray-600 font-typewriter italic opacity-50 border-2 border-dashed border-[#333] rounded">القائمة فارغة...</div>'}
                        </div>
                    </div>

                    <div class="mt-auto">
                        <button onclick="goToCategory()" ${state.players.length < 3 ? 'disabled' : ''} class="noir-btn btn-primary w-full ${state.players.length < 3 ? 'opacity-50 cursor-not-allowed' : ''}">
                            <i data-lucide="search" class="w-5 h-5"></i> بدء التحقيق
                        </button>
                    </div>
                </div>
            `;
        }

        function renderCategory(container) {
            const categoriesHtml = Object.keys(CATEGORIES).map(cat => `
                <button onclick="startGame('${cat}')" class="h-24 bg-[#1a1a1a] border border-[#333] hover:border-[#f0e6d2] hover:bg-[#222] text-[#f0e6d2] font-typewriter text-lg flex flex-col items-center justify-center gap-2 relative active:scale-95 transition-all group overflow-hidden">
                    <div class="absolute -right-4 -top-4 w-16 h-16 bg-[#f0e6d2] opacity-5 rounded-full group-hover:scale-150 transition-transform duration-500"></div>
                    <i data-lucide="folder-open" class="w-6 h-6 opacity-50 group-hover:opacity-100 transition-opacity text-[#d4c5a5]"></i>
                    <span class="relative z-10">${cat}</span>
                </button>
            `).join('');

            container.innerHTML = `
                <div class="flex flex-col h-full animate-slide-up">
                    
                    <!-- Back Button -->
                    <div class="mb-4">
                        <button onclick="setState('setup')" class="text-[#f0e6d2] flex items-center gap-2 hover:underline text-xs font-typewriter uppercase">
                            <i data-lucide="arrow-right" class="w-4 h-4"></i> الرجوع للقائمة
                        </button>
                    </div>

                    <div class="text-center mb-6 relative">
                        <h2 class="text-2xl font-typewriter font-bold text-[#f0e6d2] uppercase tracking-widest inline-block bg-[#0a0a0a] px-4 relative z-10">مسرح الجريمة</h2>
                        <div class="absolute top-1/2 left-0 w-full h-[1px] bg-[#333] z-0"></div>
                        <p class="text-[10px] text-gray-500 mt-2 font-mono">حدد موقع الحادثة للمتابعة</p>
                    </div>

                    <div class="grid grid-cols-2 gap-4 pb-8 overflow-y-auto">
                        ${categoriesHtml}
                        <button onclick="setState('custom')" class="col-span-2 h-16 bg-transparent border-2 border-dashed border-gray-600 hover:border-[#f0e6d2] text-gray-400 hover:text-[#f0e6d2] font-typewriter flex items-center justify-center gap-2 transition-colors">
                            <i data-lucide="file-text" class="w-5 h-5"></i> تقرير مخصص (إدخال يدوي)
                        </button>
                    </div>
                </div>
            `;
        }

        function renderCustom(container) {
            container.innerHTML = `
                <div class="flex flex-col h-full gap-4 animate-slide-up">
                    <div class="flex items-center gap-2 mb-2 text-[#f0e6d2] border-b border-[#333] pb-2">
                        <button onclick="setState('category')" class="hover:text-white transition-colors text-xs uppercase tracking-wider flex items-center gap-1"> 
                            <i data-lucide="arrow-right" class="w-3 h-3"></i> رجوع
                        </button>
                        <span class="text-gray-500">|</span>
                        <span class="text-sm font-bold">تقرير سري</span>
                    </div>
                    
                    <div class="case-file flex-1 shadow-inner relative">
                        <div class="paper-clip"></div>
                        <div class="absolute -top-6 left-0 bg-black text-white px-4 py-1 text-xs font-typewriter -rotate-1 shadow-[2px_2px_0px_#8b0000]">
                            EVIDENCE_LIST_001
                        </div>
                        <textarea id="customWords" placeholder="أدخل الكلمات هنا (افصل بفاصلة)..." class="w-full h-full bg-transparent text-black font-typewriter text-lg p-2 outline-none resize-none border-none leading-relaxed placeholder:text-gray-400/50"></textarea>
                    </div>
                    
                    <button onclick="handleCustomGame()" class="noir-btn btn-primary w-full">إرفاق بالأدلة</button>
                </div>
            `;
        }

        function renderPassPhone(container) {
            const player = state.players[state.currentPlayerIndex];
            
            // This screen has two states managed internally or by re-rendering: 
            // 1. "Tap to reveal" (The button)
            // 2. "Role revealed" (The card)
            // We'll handle this by a local check before calling render, or simpler: render handles both via a sub-state logic if needed.
            // But since we are using Vanilla JS, we can just manipulate the DOM for the reveal interaction to avoid full re-render flickering.
            
            container.innerHTML = `
                <div class="h-full flex flex-col items-center justify-center text-center gap-8 animate-slide-up relative">
                    
                    <!-- IDLE STATE -->
                    <div id="passStateIdle" class="flex flex-col items-center gap-8 w-full">
                        <div class="relative group cursor-default">
                            <div class="absolute inset-0 bg-[#f0e6d2] blur-2xl opacity-5 rounded-full"></div>
                            <div class="relative border-2 border-[#f0e6d2] p-8 rounded-full bg-[#0a0a0a]">
                                <i data-lucide="users" class="text-[#f0e6d2] w-12 h-12"></i>
                            </div>
                            <div class="absolute -bottom-3 left-1/2 -translate-x-1/2 bg-[#0a0a0a] text-[#f0e6d2] px-2 text-xs border border-[#333]">CONFIDENTIAL</div>
                        </div>

                        <div class="space-y-3 w-full">
                            <p class="text-gray-500 text-xs font-typewriter tracking-[0.2em] uppercase">المشتبه به الحالي</p>
                            <div class="bg-[#f0e6d2] text-black w-full py-4 font-bold font-typewriter text-3xl transform -rotate-1 shadow-[0_5px_15px_rgba(0,0,0,0.5)] relative overflow-hidden" style="background-image: url('https://www.transparenttextures.com/patterns/paper.png');">
                                <span class="relative z-10">${player}</span>
                                <div class="absolute top-0 left-0 w-full h-1 bg-black/10"></div>
                            </div>
                        </div>

                        <div class="border border-[#8b0000] text-[#8b0000] px-4 py-2 text-xs font-typewriter uppercase tracking-widest bg-[#1a0000]">
                            <i data-lucide="alert-triangle" class="inline w-3 h-3 mr-1"></i> سري للغاية - للعيون فقط
                        </div>

                        <!-- Scan Button -->
                        <div id="scanBtn" class="mt-6 relative w-72 h-32 bg-[#151515] border-2 border-[#333] hover:border-[#f0e6d2] group active:scale-95 transition-all flex flex-col items-center justify-center gap-3 cursor-pointer select-none overflow-hidden rounded-lg">
                            <div id="scanLine" class="absolute top-0 left-0 h-full bg-[#f0e6d2] mix-blend-overlay transition-all duration-75 ease-linear opacity-20" style="width: 0%"></div>
                            <i data-lucide="fingerprint" class="w-12 h-12 text-gray-700 transition-all duration-300 relative z-10" id="fingerIcon"></i>
                            <div class="text-[#f0e6d2] font-bold tracking-widest uppercase text-xs animate-pulse relative z-10" id="scanText">اضغط مطولاً للكشف</div>
                        </div>
                    </div>

                    <!-- REVEALED STATE (Hidden initially) -->
                    <div id="passStateRevealed" class="hidden w-full flex-col items-center gap-6 w-full animate-slide-up">
                        <div class="case-file w-full transform rotate-1 case-folder relative">
                            <div class="paper-clip"></div>
                            <div class="absolute top-10 right-4 transform rotate-[-20deg] border-4 border-[#8b0000] text-[#8b0000] px-4 py-1 font-bold font-typewriter text-xl opacity-80 pointer-events-none z-0">
                                ${state.currentPlayerIndex === state.imposterIndex ? 'متهم' : 'شاهد'}
                            </div>

                            <div class="flex flex-col items-center gap-6 py-6 relative z-10">
                                ${state.currentPlayerIndex === state.imposterIndex ? `
                                    <div class="w-24 h-24 bg-[#1a1a1a] rounded-full flex items-center justify-center border-4 border-[#8b0000]">
                                        <i data-lucide="eye-off" class="text-[#8b0000] w-12 h-12"></i>
                                    </div>
                                    <div class="text-center">
                                        <h2 class="text-3xl font-black text-[#8b0000] font-typewriter uppercase mb-2 tracking-tighter">أنت المخادع</h2>
                                        <p class="text-sm font-bold text-gray-600 bg-white/50 px-2 inline-block">حاول التمويه والإنكار</p>
                                    </div>
                                ` : `
                                    <div class="w-24 h-24 bg-[#1a1a1a] rounded-full flex items-center justify-center border-4 border-[#d4c5a5]">
                                        <i data-lucide="target" class="text-[#f0e6d2] w-12 h-12"></i>
                                    </div>
                                    <div class="text-center w-full">
                                        <p class="text-[10px] text-gray-500 font-typewriter uppercase mb-2 tracking-widest">الدليل القاطع:</p>
                                        <h2 class="text-4xl font-black border-y-2 border-dashed border-black py-2 font-typewriter bg-white/20">
                                            ${state.secretWord}
                                        </h2>
                                    </div>
                                `}
                            </div>
                        </div>
                        
                        <button onclick="handleNextPlayer()" class="noir-btn btn-secondary w-full py-4 text-lg shadow-lg mt-4">
                            ${state.currentPlayerIndex < state.players.length - 1 ? 'التالي >>' : 'بدء التحقيق >>'}
                        </button>
                    </div>

                </div>
            `;

            // Initialize Scanner Logic
            const btn = document.getElementById('scanBtn');
            const scanLine = document.getElementById('scanLine');
            const fingerIcon = document.getElementById('fingerIcon');
            const scanText = document.getElementById('scanText');
            let interval;
            let progress = 0;

            const startScan = (e) => {
                e.preventDefault(); // Prevent text selection
                clearInterval(interval);
                interval = setInterval(() => {
                    progress += 4;
                    scanLine.style.width = `${progress}%`;
                    fingerIcon.classList.add('text-[#f0e6d2]', 'scale-110');
                    fingerIcon.classList.remove('text-gray-700');
                    scanText.innerText = "جاري المسح...";
                    
                    if (progress >= 100) {
                        clearInterval(interval);
                        if (navigator.vibrate) navigator.vibrate(50);
                        document.getElementById('passStateIdle').classList.add('hidden');
                        document.getElementById('passStateRevealed').classList.remove('hidden');
                        document.getElementById('passStateRevealed').classList.add('flex');
                    }
                }, 20);
            };

            const stopScan = () => {
                clearInterval(interval);
                progress = 0;
                scanLine.style.width = '0%';
                fingerIcon.classList.remove('text-[#f0e6d2]', 'scale-110');
                fingerIcon.classList.add('text-gray-700');
                scanText.innerText = "اضغط مطولاً للكشف";
            };

            btn.addEventListener('mousedown', startScan);
            btn.addEventListener('mouseup', stopScan);
            btn.addEventListener('mouseleave', stopScan);
            btn.addEventListener('touchstart', startScan);
            btn.addEventListener('touchend', stopScan);
        }

        function renderPlaying(container) {
            container.innerHTML = `
                <div class="h-full flex flex-col justify-between py-6 animate-slide-up">
                    <div class="text-center space-y-8">
                        <!-- Timer -->
                        <div class="inline-block relative group">
                            <div class="absolute inset-0 border border-[#f0e6d2] transform translate-x-1 translate-y-1"></div>
                            <div class="bg-[#1a1a1a] border border-[#f0e6d2] px-10 py-5 relative z-10">
                                <div class="text-[10px] text-gray-500 font-typewriter mb-1 uppercase tracking-widest">الزمن المنقضي</div>
                                <div class="text-5xl font-typewriter font-bold text-[#f0e6d2] tabular-nums tracking-widest" id="gameTimer">
                                    ${formatTime(state.timer)}
                                </div>
                            </div>
                        </div>

                        <!-- First Player -->
                        <div class="flex justify-center">
                            <div class="bg-[#f0e6d2] text-black p-4 w-full max-w-xs relative shadow-[0_10px_20px_rgba(0,0,0,0.5)] transform -rotate-2 border border-gray-400" style="background-image: url('https://www.transparenttextures.com/patterns/paper.png');">
                                <div class="absolute -top-3 left-1/2 -translate-x-1/2 w-4 h-4 rounded-full bg-red-900 shadow-sm border border-black/20 z-20"></div>
                                <div class="text-center mt-2">
                                    <div class="flex items-center justify-center gap-2 mb-2 text-[#8b0000]">
                                        <i data-lucide="crown" class="w-4 h-4 fill-current"></i>
                                        <span class="text-[10px] font-bold uppercase tracking-widest">رئيس التحقيق</span>
                                    </div>
                                    <div class="text-2xl font-bold font-typewriter uppercase">${state.players[state.firstPlayerIndex]}</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="space-y-4">
                        <div class="text-center text-xs text-gray-500 font-typewriter">
                            موقع الجريمة: <span class="text-[#f0e6d2] border-b border-[#f0e6d2] pb-0.5 font-bold">${state.selectedCategory}</span>
                        </div>
                        <button onclick="setState('voting')" class="noir-btn btn-danger w-full text-lg py-4">
                            <i data-lucide="gavel" class="w-5 h-5"></i> إصدار الحكم (تصويت)
                        </button>
                    </div>
                </div>
            `;
        }

        function renderVoting(container) {
            const playersHtml = state.players.map((p, i) => `
                <button onclick="handleVote(${i})" class="relative h-32 bg-[#e6dcc5] text-black group hover:bg-[#fff] shadow-md transition-all border p-2 flex flex-col items-center justify-center gap-2 overflow-hidden">
                    <div class="absolute -top-3 left-1/2 -translate-x-1/2 w-12 h-4 bg-white/40 border-l border-r border-white/60 blur-[0.5px]"></div>
                    
                    <div class="w-12 h-12 bg-gray-300 border border-gray-400 flex items-center justify-center group-hover:grayscale-0 grayscale transition-all mb-1">
                        <span class="font-bold text-xl opacity-50 text-black">?</span>
                    </div>
                    
                    <span class="font-bold font-typewriter text-sm uppercase">${p}</span>

                    <!-- Hover Effect -->
                    <div class="absolute inset-0 bg-[#8b0000] opacity-0 group-active:opacity-90 transition-opacity flex items-center justify-center">
                        <span class="text-white font-bold uppercase border-2 border-white px-2 py-1 transform -rotate-12">اتهام</span>
                    </div>
                </button>
            `).join('');

            container.innerHTML = `
                <div class="h-full flex flex-col animate-slide-up">
                    <div class="text-center mb-8">
                        <h2 class="text-2xl font-typewriter font-bold text-[#8b0000] uppercase tracking-[0.2em] bg-[#f0e6d2] inline-block px-6 py-3 transform rotate-1 shadow-[4px_4px_0_rgba(0,0,0,0.5)] border border-black">
                            من الجاني؟
                        </h2>
                        <p class="text-gray-500 text-xs mt-4 font-typewriter">اضغط على صورة المشتبه به للتصويت</p>
                    </div>

                    <div class="grid grid-cols-2 gap-4 pb-4 overflow-y-auto custom-scrollbar">
                        ${playersHtml}
                    </div>
                </div>
            `;
        }

        function renderResult(container) {
            const isCitizensWin = state.winner === 'citizens';
            
            container.innerHTML = `
                <div class="h-full flex flex-col items-center justify-center text-center gap-8 animate-slide-up relative z-20">
                    <div class="case-file w-full transform rotate-1 case-folder relative">
                        <div class="paper-clip"></div>
                        <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 border-4 ${isCitizensWin ? 'border-green-800 text-green-800' : 'border-[#8b0000] text-[#8b0000]'} px-6 py-2 text-4xl font-black font-typewriter -rotate-12 opacity-0 stamp-animation pointer-events-none whitespace-nowrap z-30 mix-blend-multiply">
                            ${isCitizensWin ? 'SOLVED' : 'COLD CASE'}
                        </div>

                        <div class="flex flex-col items-center gap-8 py-4">
                            <div class="p-4 border-4 rounded-full ${isCitizensWin ? 'border-green-800 text-green-800' : 'border-[#8b0000] text-[#8b0000]'}">
                                <i data-lucide="${isCitizensWin ? 'check' : 'eye-off'}" class="w-12 h-12"></i>
                            </div>
                            
                            <div class="relative">
                                <h2 class="text-3xl font-black font-typewriter uppercase mb-2 ${isCitizensWin ? 'text-green-900' : 'text-[#8b0000]'}">
                                    ${isCitizensWin ? 'تم حل القضية' : 'الجاني هرب'}
                                </h2>
                                <div class="w-full h-1 bg-black/10 mx-auto"></div>
                            </div>

                            <div class="w-full bg-white/40 p-5 border border-gray-400 font-typewriter text-sm space-y-3 text-left shadow-inner">
                                <div class="flex justify-between border-b border-gray-300 pb-2 border-dashed">
                                    <span class="text-gray-600 uppercase tracking-wider">المخادع:</span>
                                    <span class="font-bold text-[#8b0000] text-lg">${state.players[state.imposterIndex]}</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-gray-600 uppercase tracking-wider">الكلمة:</span>
                                    <span class="font-bold text-black text-xl bg-[#ffff00]/30 px-2">${state.secretWord}</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="w-full flex flex-col gap-3">
                        <button onclick="restartGame()" class="noir-btn btn-primary py-4 w-full">
                            <i data-lucide="search" class="w-5 h-5"></i> قضية جديدة
                        </button>
                        <button onclick="resetGame()" class="noir-btn btn-ghost w-full">
                            العودة للأرشيف
                        </button>
                    </div>
                </div>
            `;
        }

        // --- ACTIONS ---

        function setState(screen) {
            state.screen = screen;
            render();
        }

        function addPlayer() {
            const input = document.getElementById('newPlayerInput');
            const name = input.value.trim();
            if (name && !state.players.includes(name)) {
                state.players.push(name);
                render();
                // Keep focus
                setTimeout(() => document.getElementById('newPlayerInput')?.focus(), 10);
            }
        }

        function removePlayer(index) {
            state.players.splice(index, 1);
            render();
        }

        function handleEnter(e) {
            if (e.key === 'Enter') addPlayer();
        }

        function goToCategory() {
            if (state.players.length < 3) return;
            setState('category');
        }

        function startGame(category) {
            let words = CATEGORIES[category];
            if (category === 'عشوائي') {
                const keys = Object.keys(CATEGORIES).filter(k => k !== 'عشوائي');
                words = CATEGORIES[keys[Math.floor(Math.random() * keys.length)]];
                category = 'عشوائي'; // Keep label as random or change? User expects random.
            }

            const secretWord = words[Math.floor(Math.random() * words.length)];
            const imposterIndex = Math.floor(Math.random() * state.players.length);
            const firstPlayerIndex = Math.floor(Math.random() * state.players.length);

            state.selectedCategory = category;
            state.secretWord = secretWord;
            state.imposterIndex = imposterIndex;
            state.firstPlayerIndex = firstPlayerIndex;
            state.currentPlayerIndex = 0;
            state.timer = 0;
            
            setState('pass-phone');
        }

        function handleCustomGame() {
            const input = document.getElementById('customWords');
            const val = input.value;
            const words = val.split(/,|،|\n/).map(w => w.trim()).filter(w => w.length > 0);
            
            if (words.length < 2) {
                alert('الرجاء إدخال كلمتين على الأقل للمتابعة.');
                return;
            }
            
            // Temporary override categories for this game
            const categoryName = 'ملف مخصص';
            CATEGORIES[categoryName] = words;
            startGame(categoryName);
        }

        function handleNextPlayer() {
            if (state.currentPlayerIndex + 1 < state.players.length) {
                state.currentPlayerIndex++;
                setState('pass-phone');
            } else {
                startTimer();
                setState('playing');
            }
        }

        function startTimer() {
            if (state.timerInterval) clearInterval(state.timerInterval);
            state.timer = 0;
            state.timerInterval = setInterval(() => {
                state.timer++;
                const el = document.getElementById('gameTimer');
                if (el) el.innerText = formatTime(state.timer);
            }, 1000);
        }

        function handleVote(suspectIndex) {
            clearInterval(state.timerInterval);
            state.winner = (suspectIndex === state.imposterIndex) ? 'citizens' : 'imposter';
            setState('result');
        }

        function restartGame() {
            // Keep players, reset round
            startGame(state.selectedCategory === 'ملف مخصص' ? 'ملف مخصص' : state.selectedCategory); 
            // Note: If custom words were not saved in state properly for replay, this might need adjustment. 
            // For simplicity, we re-use if valid, or just go to category select if complex.
            // Let's actually go to category select to be safe.
            if (state.selectedCategory === 'ملف مخصص') {
                 // If we want to replay custom, we need to persist the words. 
                 // For now, let's just go back to category to keep it simple.
                 setState('category');
            } else {
                 startGame(state.selectedCategory);
            }
        }

        function resetGame() {
            clearInterval(state.timerInterval);
            state.screen = 'setup';
            state.timer = 0;
            render();
        }

        // --- UTILS ---
        function formatTime(s) {
            const mins = Math.floor(s / 60);
            const secs = s % 60;
            return `${mins}:${secs < 10 ? '0' : ''}${secs}`;
        }

        function showRules() {
            document.getElementById('rulesModal').classList.remove('hidden');
        }

        function closeRules() {
            document.getElementById('rulesModal').classList.add('hidden');
        }

        // --- INIT ---
        render();

    </script>
</body>
</html>
