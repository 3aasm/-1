<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>لعبة المحقق (المخادع)</title>
    <meta name="theme-color" content="#121212">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="icon" href="صورة التطبيق.png">
    <link rel="apple-touch-icon" href="صورة التطبيق.png">
    <style></style>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Courier+Prime:wght@400;700&family=Tajawal:wght@400;700;900&display=swap" rel="stylesheet">

    <style>
        /* --- SPLASH SCREEN --- */
        #splash-screen {
            position: fixed;
            inset: 0;
            background: linear-gradient(135deg, #0a0a0a 0%, #050505 50%, #0f0f0f 100%);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            animation: splash-fade-in 3s ease-out forwards;
            overflow: hidden;
        }

        #splash-screen::before {
            content: '';
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at 50% 50%, rgba(139, 0, 0, 0.1) 0%, transparent 70%);
            animation: pulse-glow 3s ease-in-out forwards;
            pointer-events: none;
        }

        @keyframes pulse-glow {
            0% { opacity: 0; transform: scale(0.8); }
            50% { opacity: 1; transform: scale(1); }
            100% { opacity: 0; transform: scale(1.2); }
        }

        @keyframes splash-fade-in {
            0% { opacity: 1; }
            65% { opacity: 1; }
            88% { opacity: 0.5; }
            100% { opacity: 0; visibility: hidden; }
        }

        #splash-screen.hidden {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
            animation: none;
        }

        .detective-scene {
            position: relative;
            width: 180px;
            height: 180px;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 1.5rem;
            animation: scene-float 3s ease-in-out forwards;
            z-index: 10;
        }

        @keyframes scene-float {
            0% { opacity: 0; transform: translateY(-30px) scale(0.9); }
            15% { opacity: 1; transform: translateY(0) scale(1); }
            50% { transform: translateY(-10px) scale(1.02); }
            100% { opacity: 0; transform: translateY(30px) scale(0.95); }
        }

        .detective-silhouette {
            position: relative;
            width: 90px;
            height: 90px;
            background: #1a1a1a;
            border-radius: 50%;
            box-shadow: 0 0 0 8px #0a0a0a, 0 0 30px rgba(139, 0, 0, 0.3), inset 0 0 20px rgba(0, 0, 0, 0.8);
            z-index: 1;
            animation: silhouette-pulse 3s ease-in-out forwards;
        }

        @keyframes silhouette-pulse {
            0% { box-shadow: 0 0 0 10px #0a0a0a, 0 0 20px rgba(139, 0, 0, 0.2), inset 0 0 20px rgba(0, 0, 0, 0.8); }
            50% { box-shadow: 0 0 0 10px #0a0a0a, 0 0 40px rgba(139, 0, 0, 0.5), inset 0 0 30px rgba(0, 0, 0, 0.6); }
            100% { box-shadow: 0 0 0 10px #0a0a0a, 0 0 20px rgba(139, 0, 0, 0.2), inset 0 0 20px rgba(0, 0, 0, 0.8); }
        }

        /* Fedora Hat */
        .fedora-top {
            position: absolute;
            top: -30px;
            left: 50%;
            transform: translateX(-50%);
            width: 52px;
            height: 45px;
            background: #111;
            border-radius: 10px 10px 0 0;
            z-index: 3;
        }
        .fedora-brim {
            position: absolute;
            top: 8px;
            left: 50%;
            transform: translateX(-50%) rotate(-5deg);
            width: 97px;
            height: 15px;
            background: linear-gradient(180deg, #1a1a1a 0%, #111 50%, #0a0a0a 100%);
            border-radius: 50%;
            z-index: 4;
            box-shadow: 0 4px 12px rgba(0,0,0,0.7), 0 -2px 6px rgba(255, 255, 255, 0.05);
            animation: fedora-tilt 3s ease-in-out forwards;
        }

        @keyframes fedora-tilt {
            0% { transform: translateX(-50%) rotate(-8deg) translateY(-5px); }
            50% { transform: translateX(-50%) rotate(-2deg) translateY(0); }
            100% { transform: translateX(-50%) rotate(-8deg) translateY(5px); }
        }

        /* Magnifying Glass */
        .magnifier {
            position: absolute;
            top: 0;
            left: 0;
            width: 60px;
            height: 60px;
            border: 4px solid #d4c5a5;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: brightness(1.5) blur(1px);
            box-shadow: 0 0 15px rgba(212, 197, 165, 0.2);
            z-index: 10;
            animation: search-glass 4s ease-in-out infinite;
        }
        .magnifier::after { /* Handle */
            content: '';
            position: absolute;
            bottom: -30px;
            right: -30px;
            width: 45px;
            height: 9px;
            background: #5c4033;
            transform: rotate(45deg);
            border-radius: 5px;
            box-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        @keyframes search-glass {
            0% { transform: translate(105px, 52px) rotate(0deg) scale(1); box-shadow: 0 0 20px rgba(212, 197, 165, 0.3), 0 0 40px rgba(139, 0, 0, 0.2); }
            25% { transform: translate(52px, 22px) rotate(-15deg) scale(1.05); box-shadow: 0 0 25px rgba(212, 197, 165, 0.35), 0 0 50px rgba(212, 197, 165, 0.15); }
            50% { transform: translate(-22px, 52px) rotate(15deg) scale(1.02); box-shadow: 0 0 20px rgba(212, 197, 165, 0.3), 0 0 40px rgba(139, 0, 0, 0.2); }
            75% { transform: translate(52px, 82px) rotate(-12deg) scale(1.05); box-shadow: 0 0 25px rgba(212, 197, 165, 0.35), 0 0 50px rgba(212, 197, 165, 0.15); }
            100% { transform: translate(105px, 52px) rotate(0deg) scale(1); box-shadow: 0 0 20px rgba(212, 197, 165, 0.3), 0 0 40px rgba(139, 0, 0, 0.2); }
        }

        .splash-title {
            font-family: 'Tajawal', sans-serif;
            font-size: 2.5rem;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 2px;
            background: linear-gradient(90deg, #555 0%, #999 15%, #f0e6d2 45%, #f0e6d2 55%, #999 85%, #555 100%);
            background-size: 200% auto;
            color: transparent;
            -webkit-background-clip: text;
            background-clip: text;
            animation: shine-text 3s ease-in-out forwards, title-pop 3s ease-out forwards, title-glow 3s ease-in-out forwards;
            opacity: 0;
            filter: drop-shadow(0 0 10px rgba(240, 230, 210, 0.2));
            z-index: 10;
        }

        @keyframes shine-text {
            0% { background-position: 200% center; }
            100% { background-position: -200% center; }
        }

        @keyframes title-pop {
            0% { opacity: 0; transform: translateY(30px) scale(0.8); filter: blur(5px); }
            20% { opacity: 1; transform: translateY(0) scale(1); filter: blur(0); }
            80% { opacity: 1; transform: translateY(0) scale(1); }
            100% { opacity: 0; transform: translateY(-20px) scale(0.9); filter: blur(3px); }
        }

        @keyframes title-glow {
            0% { text-shadow: 0 0 10px rgba(240, 230, 210, 0), 0 0 20px rgba(139, 0, 0, 0); }
            50% { text-shadow: 0 0 20px rgba(240, 230, 210, 0.4), 0 0 40px rgba(139, 0, 0, 0.2); }
            100% { text-shadow: 0 0 10px rgba(240, 230, 210, 0.1), 0 0 20px rgba(139, 0, 0, 0.1); }
        }

        /* --- GLOBAL STYLES & NOIR THEME --- */
        :root {
            --bg-color: #121212;
            --paper-color: #f0e6d2;
            --ink-color: #1a1a1a;
            --accent-red: #8b0000;
            --accent-gold: #d4c5a5;
        }

        body {
            font-family: 'Tajawal', sans-serif;
            background-color: var(--bg-color);
            color: #e0e0e0;
            overflow: hidden; /* Prevent scrolling on body */
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        .font-typewriter {
            font-family: 'Courier Prime', monospace, 'Tajawal', sans-serif;
        }

        /* --- ANIMATIONS --- */
        @keyframes grain {
            0%, 100% { transform: translate(0, 0); }
            10% { transform: translate(-5%, -10%); }
            20% { transform: translate(-15%, 5%); }
            30% { transform: translate(7%, -25%); }
            40% { transform: translate(-5%, 25%); }
            50% { transform: translate(-15%, 10%); }
            60% { transform: translate(15%, 0%); }
            70% { transform: translate(0%, 15%); }
            80% { transform: translate(3%, 35%); }
            90% { transform: translate(-10%, 10%); }
        }

        .film-grain {
            position: fixed;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background-image: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI1MTIiIGhlaWdodD0iNTEyIj48ZmlsdGVyIGlkPSJnoiPjxmZVR1cmJ1bGVuY2UgdHlwZT0iZnJhY3RhbE5vaXNlIiBiYXNlRnJlcXVlbmN5PSIwLjY1IiBudW1PY3RhdmVzPSIzIiBzdGl0Y2hUaWxlcz0ic3RpdGNoIi8+PC9maWx0ZXI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsdGVyPSJ1cmwoI2cpIiBvcGFjaXR5PSIwLjUiLz48L3N2Zz4=');
            opacity: 0.05;
            animation: grain 8s steps(10) infinite;
            pointer-events: none;
            z-index: 0;
        }

        @keyframes flicker {
            0% { opacity: 0.95; }
            5% { opacity: 0.85; }
            10% { opacity: 0.95; }
            15% { opacity: 0.75; }
            20% { opacity: 0.95; }
            50% { opacity: 0.95; }
            55% { opacity: 0.85; }
            60% { opacity: 0.95; }
            100% { opacity: 0.95; }
        }

        .light-flicker {
            position: fixed;
            inset: 0;
            background: radial-gradient(circle at 50% 30%, rgba(255, 255, 220, 0.05), transparent 70%);
            animation: flicker 6s infinite;
            pointer-events: none;
            z-index: 1;
        }

        @keyframes stamp-in {
            0% { opacity: 0; transform: scale(2) rotate(-10deg); }
            100% { opacity: 1; transform: scale(1) rotate(-2deg); }
        }

        .stamp-animation {
            animation: stamp-in 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }

        @keyframes slide-up {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .animate-slide-up {
            animation: slide-up 0.5s ease-out forwards;
        }

        /* --- UI ELEMENTS --- */
        .noir-btn {
            position: relative;
            font-family: 'Courier Prime', monospace;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            padding: 12px 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            border: 2px solid black;
            transition: all 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
            cursor: pointer;
            overflow: hidden;
        }
        
        .noir-btn:active {
            transform: translateY(2px);
            box-shadow: none !important;
        }

        .noir-btn:hover {
            transform: translateY(-3px) scale(1.02);
            filter: brightness(1.1);
        }

        .btn-primary {
            background-color: var(--ink-color);
            color: var(--paper-color);
            box-shadow: 4px 4px 0px var(--accent-red);
        }
        
        .btn-secondary {
            background-color: var(--paper-color);
            color: var(--ink-color);
            border-style: dashed;
            box-shadow: 4px 4px 0px rgba(0,0,0,0.5);
        }

        .btn-danger {
            background-color: var(--accent-red);
            color: var(--paper-color);
            box-shadow: 4px 4px 0px black;
        }

        .case-file {
            background-color: var(--paper-color);
            background-image: url('https://www.transparenttextures.com/patterns/paper.png');
            color: var(--ink-color);
            padding: 24px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            position: relative;
        }

        .case-file::before {
            content: '';
            position: absolute;
            inset: 0;
            background-image: url('https://www.transparenttextures.com/patterns/notebook.png');
            opacity: 0.1;
            pointer-events: none;
        }

        .case-folder {
            border-top: 8px solid var(--accent-gold);
            border-radius: 0 40px 0 0;
        }

        .paper-clip {
            position: absolute;
            top: -12px;
            left: 50%;
            transform: translateX(-50%);
            width: 20px;
            height: 50px;
            border: 4px solid #999;
            border-radius: 20px;
            z-index: 10;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: #1a1a1a; }
        ::-webkit-scrollbar-thumb { background: #555; }

        .hidden { display: none !important; }
        
        /* Input Focus Ring */
        input:focus {
            outline: none;
            border-color: var(--paper-color);
            background-color: #222;
        }

        /* Modal Animation */
        .modal-enter { animation: slide-up 0.3s ease-out forwards; }
        
        /* Score Badge */
        .score-badge { font-family: 'Courier Prime', monospace; font-weight: bold; color: var(--accent-gold); }

        /* New Pop-in Animation */
        @keyframes pop-in {
            0% { opacity: 0; transform: scale(0.8) translateY(10px); }
            100% { opacity: 1; transform: scale(1) translateY(0); }
        }

        /* Walking Animation */
        @keyframes walk-cycle {
            0% { transform: translateX(-100%) translateY(0) rotate(5deg); opacity: 0; }
            10% { opacity: 0.2; }
            50% { transform: translateX(0%) translateY(-5px) rotate(-5deg); opacity: 0.5; }
            90% { opacity: 0.2; }
            100% { transform: translateX(100%) translateY(0) rotate(5deg); opacity: 0; }
        }
        .walking-figure { animation: walk-cycle 8s linear infinite; }

        .splash-lines {
            position: absolute;
            inset: 0;
            pointer-events: none;
        }

        .splash-line {
            position: absolute;
            background: linear-gradient(90deg, transparent 0%, rgba(240, 230, 210, 0.1) 50%, transparent 100%);
            animation: line-scan 3s ease-in-out forwards;
        }

        @keyframes line-scan {
            0% { transform: translateY(-100%) scaleX(0.8); opacity: 0; }
            20% { opacity: 1; }
            80% { opacity: 1; }
            100% { transform: translateY(100%) scaleX(1); opacity: 0; }
        }

        /* Transition Animation */
        @keyframes slide-transition {
            0% { transform: translateX(100%); }
            45% { transform: translateX(0); }
            55% { transform: translateX(0); }
            100% { transform: translateX(-100%); }
        }
        
        .transition-overlay {
            position: fixed;
            inset: 0;
            z-index: 100;
            background: #1a1a1a;
            border-left: 4px solid #8b0000;
            pointer-events: none;
            animation: slide-transition 0.6s cubic-bezier(0.4, 0.0, 0.2, 1) forwards;
        }

        @keyframes slide-transition-reverse {
            0% { transform: translateX(-100%); }
            45% { transform: translateX(0); }
            55% { transform: translateX(0); }
            100% { transform: translateX(100%); }
        }

        .transition-overlay.reverse {
            animation: slide-transition-reverse 0.6s cubic-bezier(0.4, 0.0, 0.2, 1) forwards;
            border-left: none;
            border-right: 4px solid #8b0000;
            background: #1a1a1a;
        }

        /* Enhanced Back Transition */
        @keyframes smooth-back-transition {
            0% { opacity: 0; transform: translateX(-100%); }
            20% { opacity: 1; transform: translateX(0); }
            80% { opacity: 1; transform: translateX(0); }
            100% { opacity: 0; transform: translateX(100%); }
        }

        .transition-back {
            position: fixed;
            inset: 0;
            z-index: 100;
            background: linear-gradient(90deg, #1a1a1a 0%, #0a0a0a 50%, #1a1a1a 100%);
            border-right: 4px solid #d4c5a5;
            pointer-events: none;
            animation: smooth-back-transition 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
        }

        /* Noir Transition Overlay */
        .noir-overlay {
            position: fixed;
            inset: 0;
            z-index: 100;
            display: flex;
            pointer-events: none;
        }
        
        .noir-panel {
            flex: 1;
            background: #0f0f0f;
            height: 100%;
            transform: scaleX(0);
            transition: transform 0.5s cubic-bezier(0.7, 0, 0.3, 1);
            border-bottom: 4px solid #8b0000;
        }
        
        .noir-panel.left { transform-origin: left; border-right: 1px solid #333; }
        .noir-panel.right { transform-origin: right; border-left: 1px solid #333; }
        
        .noir-overlay.active .noir-panel { transform: scaleX(1); }
        
        .noir-content {
            position: absolute;
            inset: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 101;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .noir-content.visible { opacity: 1; }

        .stamp-slam {
            animation: stamp-slam-anim 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }

        @keyframes stamp-slam-anim {
            0% { opacity: 0; transform: scale(3) rotate(-15deg); }
            100% { opacity: 1; transform: scale(1) rotate(-5deg); }
        }

        /* Main Content Fade-in */
        @keyframes main-fade-in {
            0% { opacity: 0; }
            30% { opacity: 0; }
            100% { opacity: 1; }
        }

        .animate-main-fade-in {
            animation: main-fade-in 1s ease-out forwards;
        }

        /* Splash Overlay */
        #splash-overlay {
            position: fixed;
            inset: 0;
            z-index: 50;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(10px);
            background: rgba(10, 10, 10, 0.4);
            animation: overlay-fade-in 0.8s ease-out forwards;
        }

        #splash-overlay.hidden {
            animation: overlay-slide-down 1s cubic-bezier(0.36, 0, 0.66, -0.56) forwards;
            pointer-events: none;
        }

        @keyframes overlay-fade-in {
            from { opacity: 0; backdrop-filter: blur(0); }
            to { opacity: 1; backdrop-filter: blur(10px); }
        }

        @keyframes overlay-slide-down {
            0% { 
                opacity: 1;;
                backdrop-filter: blur(10px);
                transform: translateY(0) scale(1);
            }
            70% {
                opacity: 0.3;
                transform: translateY(50vh) scale(0.98);
            }
            100% { 
                opacity: 0;
                backdrop-filter: blur(0);
                transform: translateY(120vh) scale(0.9);
                visibility: hidden;
            }
        }

        #splash-overlay > div {
            animation: content-fade-in 0.5s ease-out forwards;
        }

        #splash-overlay.hidden > div {
            animation: content-slide-out 0.8s cubic-bezier(0.36, 0, 0.66, -0.56) forwards;
        }

        @keyframes content-slide-out {
            0% { 
                opacity: 1;
                transform: translateY(0) scale(1);
            }
            100% { 
                opacity: 0;
                transform: translateY(100vh) scale(0.85);
            }
        }

        @keyframes content-fade-in {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .start-button {
            position: relative;
            padding: 12px 28px;
            font-size: 0.95rem;
            font-family: 'Tajawal', sans-serif;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #f0e6d2;
            background: linear-gradient(135deg, #1a1a1a 0%, #2a2a2a 100%);
            border: 2px solid #d4c5a5;
            border-radius: 0;
            cursor: pointer;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.7), 0 0 30px rgba(212, 197, 165, 0.2);
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            animation: button-pulse 2s ease-in-out infinite;
        }

        .start-button::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(90deg, transparent, rgba(212, 197, 165, 0.3), transparent);
            animation: shine 3s linear infinite;
        }

        @keyframes shine {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        @keyframes button-pulse {
            0% { box-shadow: 0 10px 30px rgba(0, 0, 0, 0.7), 0 0 30px rgba(212, 197, 165, 0.2); }
            50% { box-shadow: 0 10px 40px rgba(0, 0, 0, 0.8), 0 0 50px rgba(212, 197, 165, 0.4); }
            100% { box-shadow: 0 10px 30px rgba(0, 0, 0, 0.7), 0 0 30px rgba(212, 197, 165, 0.2); }
        }

        .start-button:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.8), 0 0 60px rgba(212, 197, 165, 0.5);
            border-color: #f0e6d2;
        }

        .start-button:active {
            transform: translateY(2px) scale(0.98);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.6), 0 0 20px rgba(212, 197, 165, 0.2);
        }

        .start-button span {
            position: relative;
            z-index: 2;
        }

        .start-icon {
            position: relative;
            z-index: 2;
            width: 18px;
            height: 18px;
            margin-right: 8px;
        }

        .start-button.clicked {
            animation: button-burst 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) forwards !important;
        }

        @keyframes button-burst {
            0% { 
                transform: scale(1);
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.7), 0 0 30px rgba(212, 197, 165, 0.2);
            }
            60% { 
                transform: scale(1.12);
                box-shadow: 0 15px 50px rgba(0, 0, 0, 0.8), 0 0 80px rgba(212, 197, 165, 0.6);
            }
            100% { 
                transform: scale(1);
                box-shadow: 0 8px 20px rgba(0, 0, 0, 0.5), 0 0 40px rgba(212, 197, 165, 0.3);
            }
        }

    </style>
</head>
<body>

    <!-- Splash Screen -->
    <div id="splash-screen">
        <div class="splash-lines" id="splashLines"></div>
        <div class="detective-scene">
            <div class="detective-silhouette">
                <div class="fedora-top"></div>
                <div class="fedora-brim"></div>
            </div>
            <div class="magnifier"></div>
        </div>
        <h1 class="splash-title">لعبة المحقق</h1>
    </div>

    <!-- Effects Layers -->
    <div class="film-grain"></div>
    <div class="light-flicker"></div>

    <!-- Splash Overlay -->
    <div id="splash-overlay" class="flex flex-col items-center justify-center gap-12">
        <div class="text-center space-y-6">
            <h2 class="text-2xl font-typewriter font-black text-[#f0e6d2] uppercase tracking-wide drop-shadow-lg">مرحبا بك</h2>
            <p class="text-[#d4c5a5] text-xs font-typewriter tracking-wider">هل أنت مستعد للتحقيق؟</p>
        </div>
        <button onclick="startInvestigation()" class="start-button flex items-center justify-center active:scale-95">
            <i data-lucide="play" class="start-icon"></i>
            <span>ابدأ التحقيق</span>
        </button>
    </div>

    <div id="main-content" class="relative z-10 w-full max-w-md mx-auto h-screen flex flex-col bg-[#0a0a0a] border-x border-[#333] shadow-2xl opacity-0 transition-opacity duration-1000 animate-main-fade-in">
        
        <!-- Header -->
        <header class="px-4 py-2 flex justify-between items-center z-20 border-b border-[#333] bg-[#0f0f0f] shadow-lg shrink-0">
            <div class="flex items-center gap-3">
                <img src="صورة التطبيق.png" alt="Logo" class="w-10 h-10 rounded-full border-2 border-[#1a1a1a] shadow-[0_0_15px_rgba(139,0,0,0.3)] object-cover bg-[#0a0a0a]">
                <div>
                    <h1 class="font-typewriter font-bold text-lg tracking-widest text-[#f0e6d2] drop-shadow-md">المخادع</h1>
                    <p class="text-[10px] text-gray-500 font-typewriter tracking-wider uppercase flex items-center gap-1">
                        <span class="w-2 h-2 bg-red-900 rounded-full animate-pulse"></span>
                        تحقيق جاري
                    </p>
                </div>
            </div>
            
            <div class="flex gap-2">
                <button onclick="toggleSettings(true)" id="settingsBtn" class="p-1.5 text-[#f0e6d2] hover:bg-white/5 rounded transition"><i data-lucide="settings" class="w-5 h-5"></i></button>
                <button onclick="resetPoints()" id="resetPointsBtn" class="hidden group relative px-3 py-1.5 rounded-lg transition-all duration-300 shadow-md hover:shadow-lg flex items-center gap-2" style="background: linear-gradient(135deg, #1a1a1a 0%, #2a2a2a 100%); border: 1.5px solid #8b0000;"><div class="absolute inset-0 bg-gradient-to-r from-[#8b0000] to-[#5a0000] opacity-0 group-hover:opacity-30 rounded-lg transition-opacity"></div><i data-lucide="refresh-cw" class="w-4 h-4 relative z-10 text-[#d4c5a5] group-hover:text-white transition-colors"></i><span class="text-xs font-typewriter text-[#d4c5a5] group-hover:text-white transition-colors font-bold relative z-10">تصفير</span></button>
                <button onclick="showRules()" class="p-1.5 text-[#f0e6d2] hover:bg-white/5 rounded transition"><i data-lucide="help-circle" class="w-5 h-5"></i></button>
                <button onclick="showExitConfirm()" id="exitBtn" class="hidden group relative px-3 py-2 rounded-lg transition-all duration-300 shadow-md hover:shadow-lg transform hover:-translate-y-0.5 flex items-center gap-2" style="background: linear-gradient(135deg, #1a1a1a 0%, #2a2a2a 100%); border: 1.5px solid #555;"><div class="absolute inset-0 bg-gradient-to-r from-[#8b0000] to-[#5a0000] opacity-0 group-hover:opacity-20 rounded-lg transition-opacity"></div><i data-lucide="gavel" class="w-5 h-5 relative z-10 text-[#e0e0e0] group-hover:text-[#ff6b6b] transition-colors"></i><span class="text-sm font-typewriter text-[#e0e0e0] group-hover:text-[#ff6b6b] transition-colors font-bold relative z-10">خروج</span></button>
            </div>
        </header>

        <!-- Main Content Area -->
        <main id="app" class="flex-1 overflow-y-auto p-6 relative flex flex-col">
            <!-- Content will be injected here via JavaScript -->
        </main>

    </div>

    <!-- Rules Modal (Hidden by default) -->
    <div id="rulesModal" class="fixed inset-0 z-50 bg-black/95 flex items-center justify-center p-4 hidden animate-slide-up">
        <div class="case-file w-full max-w-sm transform rotate-1">
            <div class="paper-clip"></div>
            <div class="absolute -top-6 left-0 bg-black text-white px-4 py-1 text-xs font-typewriter -rotate-1 shadow-[2px_2px_0px_#8b0000]">
                دليل الإجراءات
            </div>
            
            <div class="space-y-6 text-sm font-typewriter mt-4">
                <div class="flex gap-4 items-start">
                    <span class="bg-black text-white w-6 h-6 flex items-center justify-center text-xs shrink-0 font-bold">1</span>
                    <div>
                        <p class="font-bold mb-1">توزيع الأدوار</p>
                        <p class="text-xs text-gray-600">مرر الملف لكل محقق. واحد فقط هو الجاسوس (المخادع).</p>
                    </div>
                </div>
                <div class="flex gap-4 items-start">
                    <span class="bg-black text-white w-6 h-6 flex items-center justify-center text-xs shrink-0 font-bold">2</span>
                    <div>
                        <p class="font-bold mb-1">الاستجواب</p>
                        <p class="text-xs text-gray-600">اطرحوا أسئلة ملتوية. حاولوا كشف الجاسوس دون فضح الكلمة.</p>
                    </div>
                </div>
                <div class="flex gap-4 items-start">
                    <span class="bg-black text-white w-6 h-6 flex items-center justify-center text-xs shrink-0 font-bold">3</span>
                    <div>
                        <p class="font-bold mb-1">الحكم</p>
                        <p class="text-xs text-gray-600">صوتوا للقبض على الجاسوس قبل نفاد الوقت.</p>
                    </div>
                </div>
            </div>
            <div class="mt-8 space-y-3">
                <button onclick="closeRules()" class="noir-btn btn-secondary w-full">علم، وسينفذ</button>
                <a href="https://instagram.com/ti.1k" target="_blank" class="flex items-center justify-center gap-2 w-full py-2 border-2 border-[#8b5a2b] text-[#8b5a2b] font-bold text-xs hover:bg-[#8b5a2b] hover:text-[#f0e6d2] transition-colors font-typewriter">
                    <i data-lucide="instagram" class="w-4 h-4"></i> تابعني على انستجرام @ti.1k
                </a>
            </div>
        </div>
    </div>

    <!-- Exit Confirmation Modal -->
    <div id="exitModal" class="fixed inset-0 z-[70] bg-black/95 flex items-center justify-center p-4 hidden modal-enter">
        <div class="case-file w-full max-w-sm relative transform -rotate-1">
            <div class="paper-clip"></div>
            <div class="text-center space-y-4 pt-4">
                <i data-lucide="alert-octagon" class="w-12 h-12 text-[#8b0000] mx-auto mb-2"></i>
                <h2 class="text-xl font-bold font-typewriter uppercase tracking-widest text-[#8b0000]">إغلاق القضية؟</h2>
                <p class="text-sm font-bold text-gray-700">سيتم فقدان جميع الأدلة والتقدم الحالي.</p>
                <div class="flex gap-3 mt-6">
                    <button onclick="confirmExit()" class="noir-btn btn-danger flex-1">تأكيد الخروج</button>
                    <button onclick="closeExitConfirm()" class="noir-btn btn-secondary flex-1">إلغاء</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="fixed inset-0 z-[60] bg-black/95 flex items-center justify-center p-4 hidden modal-enter">
        <div class="case-file w-full max-w-sm relative">
            <button onclick="toggleSettings(false)" class="absolute top-2 left-2 text-black hover:text-red-800"><i data-lucide="x"></i></button>
            <h2 class="text-xl font-bold mb-6 font-typewriter border-b-2 border-black pb-2">إعدادات القضية</h2>
            <div class="space-y-6">
                <div>
                    <label class="block text-sm font-bold mb-2">وقت النقاش (ثانية)</label>
                    <input type="number" id="settingTimer" class="w-full bg-[#1a1a1a] text-[#f0e6d2] p-3 font-typewriter border-2 border-black focus:border-[#8b0000]" value="60">
                </div>
                <div>
                    <label class="block text-sm font-bold mb-2">عدد جولات الأسئلة (لكل شخص)</label>
                    <input type="number" id="settingRounds" class="w-full bg-[#1a1a1a] text-[#f0e6d2] p-3 font-typewriter border-2 border-black focus:border-[#8b0000]" value="3">
                </div>
                <button onclick="saveSettings()" class="noir-btn btn-primary w-full mt-4">حفظ التغييرات</button>
            </div>
        </div>
    </div>

    <script>
        // --- DATA ---
        const CATEGORIES = {
            'حيوانات': ['أسد', 'فيل', 'زرافة', 'نمر', 'قطة', 'كلب', 'حوت', 'صقر', 'تمساح', 'بطريق', 'كنغر', 'دب', 'حصان', 'ذئب', 'ثعلب'],
            'أكلات': ['بيتزا', 'كبسة', 'برجر', 'سوشي', 'شاورما', 'مكرونة', 'فلافل', 'منسف', 'مسخن', 'كشري', 'دجاج مقلي', 'ستيك', 'ملوخية', 'محاشي'],
            'أدوات': ['مطرقة', 'مفك', 'منشار', 'قلم', 'هاتف', 'لابتوب', 'مقص', 'فرشاة', 'ملعقة', 'نظارة', 'ساعة', 'مفتاح', 'سماعة', 'شاحن'],
            'أماكن': ['مدرسة', 'مستشفى', 'مطار', 'ملعب', 'سينما', 'حديقة', 'مطعم', 'مكتبة', 'سجن', 'فندق', 'محطة قطار', 'شاطئ', 'مقهى', 'مسجد'],
            'وظائف': ['طبيب', 'مهندس', 'معلم', 'شرطي', 'طيار', 'طباخ', 'نجار', 'رسام', 'محامي', 'ممرض', 'رائد فضاء', 'حلاق', 'ميكانيكي', 'خباز'],
            'ماركات': ['تويوتا', 'آيفون', 'نايك', 'بيبسي', 'ماكدونالدز', 'سامسونج', 'مرسيدس', 'أديداس', 'جوجل', 'زارا', 'روليكس', 'سوني'],
            'دول': ['مصر', 'السعودية', 'الإمارات', 'المغرب', 'فرنسا', 'إيطاليا', 'اليابان', 'الصين', 'البرازيل', 'تركيا', 'ألمانيا', 'أمريكا'],
            'عشوائي': [] // Placeholder
        };

        // --- STATE ---
        let state = {
            screen: 'setup', // setup, category, custom, pass-phone, playing, voting, result
            players: ['المشتبه 1', 'المشتبه 2', 'المشتبه 3'],
            customCategoryName: null,
            scores: {}, // { 'PlayerName': 0 }
            settings: {
                timerDuration: 60,
                roundsPerPlayer: 3
            },
            selectedCategory: null,
            secretWord: '',
            imposterIndex: null,
            firstPlayerIndex: null,
            currentPlayerIndex: 0,
            timer: 0,
            timerInterval: null,
            questionState: { round: 1, askerIndex: 0, isCustom: false, showTransition: false },
            votingState: { currentVoterIndex: 0, votes: {}, phase: 'pass' }, // phase: 'pass' or 'vote'
            winner: null
        };

        // --- RENDER FUNCTION ---
        function render() {
            const app = document.getElementById('app');
            const exitBtn = document.getElementById('exitBtn');
            const settingsBtn = document.getElementById('settingsBtn');
            const resetPointsBtn = document.getElementById('resetPointsBtn');
            
            app.innerHTML = '';
            
            // Show/Hide Buttons based on screen
            if (state.screen === 'setup' || state.screen === 'category' || state.screen === 'custom') {
                exitBtn.classList.add('hidden');
                settingsBtn.classList.remove('hidden');
                resetPointsBtn.classList.remove('hidden');
            } else {
                exitBtn.classList.remove('hidden');
                settingsBtn.classList.add('hidden');
                resetPointsBtn.classList.add('hidden');
            }

            // Render based on screen
            switch(state.screen) {
                case 'setup': renderSetup(app); break;
                case 'category': renderCategory(app); break;
                case 'custom': renderCustom(app); break;
                case 'pass-phone': renderPassPhone(app); break;
                case 'playing': renderPlaying(app); break;
                case 'voting': renderVoting(app); break;
                case 'result': renderResult(app); break;
            }
            
            // Re-initialize icons
            lucide.createIcons();
        }

        // --- SCREENS ---

        function renderSetup(container) {
            let playersListHtml = state.players.map((p, i) => `
                <div class="flex items-center justify-between p-3 bg-[#f0e6d2] text-black shadow-md border-l-4 border-[#8b0000] transform hover:translate-x-1 transition-transform cursor-default" style="background-image: url('https://www.transparenttextures.com/patterns/paper.png'); animation: pop-in 0.3s ease-out backwards; animation-delay: ${i * 0.1}s;">
                    <div class="flex items-center gap-4">
                        <span class="font-typewriter font-bold text-xs text-[#8b0000] opacity-50">#${(i+1).toString().padStart(3, '0')}</span>
                        <div class="flex flex-col">
                            <span class="font-typewriter font-bold text-lg tracking-wide">${p}</span>
                            <span class="text-[10px] font-bold text-gray-600 flex items-center gap-1"><i data-lucide="star" class="w-3 h-3"></i> النقاط: ${state.scores[p] || 0}</span>
                        </div>
                    </div>
                    <button onclick="removePlayer(${i})" class="text-[#8b0000] hover:bg-[#8b0000] hover:text-[#f0e6d2] rounded p-1 transition-colors"><i data-lucide="x" class="w-4 h-4"></i></button>
                </div>
            `).join('');

            container.innerHTML = `
                <div class="flex flex-col gap-6 animate-slide-up pb-10 h-full">
                    
                    <!-- Leaderboard Tape -->
                    <div class="bg-[#1a1a1a] border border-[#333] p-1 shadow-inner relative mt-2">
                        <div class="absolute -top-3 left-1/2 -translate-x-1/2 w-24 h-6 bg-[#ffffff20] -rotate-1 blur-[1px]"></div>
                        <div class="bg-[#111] p-4 border border-[#333]">
                            <div class="flex justify-between items-center mb-1 border-b border-[#333] pb-1">
                                <span class="text-[10px] text-[#8b0000] font-typewriter uppercase tracking-widest font-bold">سجل المحققين</span>
                                <span class="text-[#f0e6d2] font-bold text-xs"><i data-lucide="users" class="inline w-3 h-3"></i> ${state.players.length}</span>
                            </div>
                            <div class="text-[10px] text-gray-500 font-typewriter mt-1">تم تسجيل النقاط لكل محقق في القائمة أدناه</div>
                        </div>
                    </div>

                    <!-- Add Player -->
                    <div class="flex-1 flex flex-col gap-4">
                        <div class="flex flex-col gap-2">
                            <label class="text-[10px] text-gray-500 font-typewriter uppercase tracking-widest ml-1">>> إضافة مشتبه به جديد:</label>
                            <div class="flex relative shadow-lg">
                                <input type="text" id="newPlayerInput" placeholder="الاسم..." class="flex-1 bg-[#1a1a1a] border-2 border-[#333] p-4 font-typewriter text-[#f0e6d2] transition-all" onkeypress="handleEnter(event)">
                                <button onclick="addPlayer()" class="bg-[#f0e6d2] text-black px-6 font-bold border-2 border-[#f0e6d2] hover:bg-white transition-colors flex items-center justify-center">
                                    <i data-lucide="plus" class="w-6 h-6"></i>
                                </button>
                            </div>
                        </div>

                        <div class="flex-1 overflow-y-auto space-y-2 pr-1 custom-scrollbar">
                            ${state.players.length ? playersListHtml : '<div class="text-center py-10 text-gray-600 font-typewriter italic opacity-50 border-2 border-dashed border-[#333] rounded">القائمة فارغة...</div>'}
                        </div>
                    </div>

                    <div class="mt-auto">
                        <button onclick="goToCategory()" ${state.players.length < 3 ? 'disabled' : ''} class="noir-btn btn-primary w-full ${state.players.length < 3 ? 'opacity-50 cursor-not-allowed' : ''}">
                            <i data-lucide="search" class="w-5 h-5"></i> بدء التحقيق
                        </button>
                    </div>
                </div>
            `;
        }

        function renderCategory(container) {
            const categoryIcons = {
                'حيوانات': 'cat',
                'أكلات': 'utensils',
                'أدوات': 'wrench',
                'أماكن': 'map-pin',
                'وظائف': 'briefcase',
                'ماركات': 'shopping-bag',
                'دول': 'globe',
                'عشوائي': 'shuffle'
            };

            const categoriesHtml = Object.keys(CATEGORIES).filter(cat => cat !== state.customCategoryName && cat !== 'ملف مخصص').map(cat => {
                const icon = categoryIcons[cat] || 'folder';
                return `
                <button onclick="startGame('${cat}')" class="h-24 bg-[#1a1a1a] border border-[#333] hover:border-[#f0e6d2] hover:bg-[#222] text-[#f0e6d2] font-typewriter text-lg flex flex-col items-center justify-center gap-2 relative active:scale-95 transition-all group overflow-hidden">
                    <i data-lucide="${icon}" class="absolute -right-6 -bottom-6 w-32 h-32 text-[#f0e6d2] opacity-5 group-hover:opacity-10 group-hover:scale-110 transition-all duration-500 -rotate-12"></i>
                    <i data-lucide="${icon}" class="w-6 h-6 opacity-50 group-hover:opacity-100 transition-opacity text-[#d4c5a5] relative z-10"></i>
                    <span class="relative z-10">${cat}</span>
                </button>
            `}).join('');

            const customName = state.customCategoryName || 'تقرير مخصص (إدخال يدوي)';
            const nameChangedBadge = state.customCategoryName ? `<div class="absolute -top-3 left-1/2 -translate-x-1/2 bg-[#8b0000] text-[#f0e6d2] text-[10px] px-2 py-0.5 font-bold font-typewriter border border-black shadow-sm z-20 whitespace-nowrap transform -rotate-1">تم تغيير الاسم</div>` : '';

            container.innerHTML = `
                <div class="flex flex-col h-full animate-slide-up">
                    
                    <!-- Back Button -->
                    <div class="mb-4">
                        <button onclick="handleBackToSetup()" class="text-[#f0e6d2] flex items-center gap-2 hover:underline text-xs font-typewriter uppercase">
                            <i data-lucide="arrow-right" class="w-4 h-4"></i> الرجوع للقائمة
                        </button>
                    </div>

                    <div class="text-center mb-6 relative">
                        <h2 class="text-2xl font-typewriter font-bold text-[#f0e6d2] uppercase tracking-widest inline-block bg-[#0a0a0a] px-4 relative z-10">مسرح الجريمة</h2>
                        <div class="absolute top-1/2 left-0 w-full h-[1px] bg-[#333] z-0"></div>
                        <p class="text-[10px] text-gray-500 mt-2 font-mono">حدد موقع الحادثة للمتابعة</p>
                    </div>

                    <div class="grid grid-cols-2 gap-4 pb-8 overflow-y-auto pt-4">
                        ${categoriesHtml}
                        <div class="col-span-2 relative">
                            ${nameChangedBadge}
                            <button onclick="setState('custom')" class="w-full h-24 bg-[#1a1a1a] border-2 border-dashed border-gray-600 hover:border-[#f0e6d2] text-gray-400 hover:text-[#f0e6d2] font-typewriter flex flex-col items-center justify-center gap-2 transition-colors group">
                                <i data-lucide="file-edit" class="w-8 h-8 opacity-50 group-hover:opacity-100 transition-opacity"></i>
                                <span class="text-lg">${customName}</span>
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderCustom(container) {
            container.innerHTML = `
                <div class="flex flex-col h-full gap-4 animate-slide-up">
                    <div class="flex items-center gap-2 mb-2 text-[#f0e6d2] border-b border-[#333] pb-2">
                        <button onclick="setState('category')" class="hover:text-white transition-colors text-xs uppercase tracking-wider flex items-center gap-1"> 
                            <i data-lucide="arrow-right" class="w-3 h-3"></i> رجوع
                        </button>
                        <span class="text-gray-500">|</span>
                        <span class="text-sm font-bold">تقرير سري</span>
                    </div>
                    
                    <div class="case-file flex-1 shadow-inner relative flex flex-col">
                        <div class="paper-clip"></div>
                        <div class="absolute -top-6 left-0 bg-black text-white px-4 py-1 text-xs font-typewriter -rotate-1 shadow-[2px_2px_0px_#8b0000]">
                            EVIDENCE_LIST_001
                        </div>
                        <input type="text" id="customName" placeholder="اسم الملف (اختياري)..." value="${state.customCategoryName || ''}" class="w-full bg-transparent border-b-2 border-[#333] mb-4 p-2 font-bold font-typewriter text-[#8b0000] focus:border-[#8b0000] outline-none placeholder:text-gray-500 text-center">
                        <textarea id="customWords" placeholder="أدخل الكلمات هنا (افصل بفاصلة)..." class="w-full h-full bg-transparent text-black font-typewriter text-lg p-2 outline-none resize-none border-none leading-relaxed placeholder:text-gray-400/50"></textarea>
                    </div>
                    
                    <button onclick="handleCustomGame()" class="noir-btn btn-primary w-full">إرفاق بالأدلة</button>
                </div>
            `;
        }

        function renderPassPhone(container) {
            const player = state.players[state.currentPlayerIndex];
            
            container.innerHTML = `
                <div class="h-full flex flex-col items-center justify-center text-center gap-6 relative">
                    
                    <!-- IDLE STATE -->
                    <div id="passStateIdle" class="flex flex-col items-center gap-8 w-full h-full justify-center px-4">
                        <div class="relative group cursor-default mb-4">
                            <div class="absolute inset-0 bg-[#f0e6d2] blur-2xl opacity-15 rounded-full scale-150 animate-pulse"></div>
                            <div class="relative border-3 border-[#d4c5a5] p-6 rounded-full bg-gradient-to-br from-[#1a1a1a] to-[#0a0a0a] shadow-2xl">
                                <i data-lucide="user" class="text-[#d4c5a5] w-11 h-11"></i>
                            </div>
                        </div>

                        <div class="space-y-4 w-full">
                            <p class="text-gray-400 text-xs font-typewriter tracking-[0.15em] uppercase">المشتبه به</p>
                            <div class="bg-yellow-50 text-[#1a1a1a] w-full py-4 px-4 font-bold font-typewriter text-2xl rounded-lg shadow-xl border-3 border-[#d4c5a5]" style="background-image: url('https://www.transparenttextures.com/patterns/paper.png');">
                                <span class="relative z-10">${player}</span>
                            </div>
                        </div>

                        <div class="flex items-center justify-center gap-2 text-[#d4c5a5] px-3 py-2 text-xs font-typewriter uppercase tracking-widest bg-[#8b0000]/20 border border-[#d4c5a5] rounded-lg">
                            <i data-lucide="shield-alert" class="w-4 h-4"></i> ممنوع فضح الدور
                        </div>

                        <!-- Scan Button with Better Design -->
                        <div id="scanBtn" class="mt-8 relative w-80 h-40 bg-gradient-to-b from-[#1a1a1a] to-[#0a0a0a] border-3 border-[#d4c5a5] hover:border-[#f0e6d2] group active:scale-95 transition-all flex flex-col items-center justify-center gap-4 cursor-pointer select-none overflow-hidden rounded-xl shadow-2xl">
                            <div id="scanLine" class="absolute top-0 left-0 h-full bg-gradient-to-r from-transparent via-[#d4c5a5] to-transparent mix-blend-screen transition-all duration-75 ease-linear opacity-30" style="width: 0%"></div>
                            <div class="absolute inset-0 opacity-0 group-hover:opacity-5 transition-opacity bg-[#d4c5a5] rounded-xl"></div>
                            <i data-lucide="fingerprint" class="w-16 h-16 text-[#d4c5a5] transition-all duration-300 relative z-10 drop-shadow-lg" id="fingerIcon"></i>
                            <div class="relative z-10 text-center">
                                <div class="text-[#d4c5a5] font-bold tracking-widest uppercase text-sm" id="scanText">اضغط مطولاً للكشف</div>
                                <div class="text-gray-500 text-xs mt-1 font-typewriter">للمسح البيومتري</div>
                            </div>
                        </div>
                    </div>

                    <!-- REVEALED STATE (Hidden initially) -->
                    <div id="passStateRevealed" class="hidden flex-col items-center gap-4 w-full h-full justify-center px-3">
                        ${state.currentPlayerIndex === state.imposterIndex ? `
                            <!-- Imposter Card -->
                            <div class="w-full space-y-4">
                                <div class="relative">
                                    <div class="absolute inset-0 bg-gradient-to-r from-[#8b0000] to-[#5a0000] blur-xl opacity-30 rounded-2xl"></div>
                                    <div class="relative bg-gradient-to-br from-[#2a0000] to-[#0a0000] border-3 border-[#8b0000] rounded-2xl p-8 shadow-2xl text-center">
                                        <div class="absolute -top-5 left-1/2 -translate-x-1/2 bg-[#8b0000] text-[#f0e6d2] px-6 py-2 rounded-full font-bold font-typewriter text-xs border-2 border-[#f0e6d2] tracking-widest">⚠️ تحذير</div>
                                        
                                        <div class="pt-4 space-y-6">
                                            <div class="w-20 h-20 bg-[#f0e6d2] rounded-full flex items-center justify-center border-4 border-[#8b0000] mx-auto shadow-lg">
                                                <i data-lucide="eye-off" class="text-[#8b0000] w-11 h-11"></i>
                                            </div>
                                            
                                            <div class="space-y-3">
                                                <h2 class="text-4xl font-black text-[#f0e6d2] font-typewriter uppercase tracking-wider animate-pulse">أنت المخادع!</h2>
                                                <p class="text-[#d4c5a5] text-sm font-bold">الكلمة السرية مجهولة لديك</p>
                                            </div>

                                            <div class="bg-[#8b0000]/30 border-2 border-[#8b0000] rounded-lg p-4 text-xs text-[#f0e6d2] font-typewriter space-y-2">
                                                <p class="font-bold uppercase">استراتيجيتك:</p>
                                                <div class="space-y-1 text-left text-[10px]">
                                                    <p>▸ استمع بعناية للأسئلة</p>
                                                    <p>▸ حاول تخمين الكلمة</p>
                                                    <p>▸ اخفِ عدم معرفتك</p>
                                                    <p>▸ ألقِ الاتهام على الآخرين</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        ` : `
                            <!-- Witness Card -->
                            <div class="w-full space-y-4">
                                <div class="relative">
                                    <div class="absolute inset-0 bg-gradient-to-r from-[#d4c5a5] to-[#a89968] blur-xl opacity-30 rounded-2xl"></div>
                                    <div class="relative bg-[#f0e6d2] border-3 border-[#1a1a1a] rounded-2xl p-6 shadow-2xl text-center">
                                        <div class="absolute -top-5 left-1/2 -translate-x-1/2 bg-[#1a1a1a] text-[#f0e6d2] px-6 py-2 rounded-full font-bold font-typewriter text-xs border-2 border-[#d4c5a5] tracking-widest">✓ محقق</div>
                                        
                                        <div class="pt-4 space-y-4">
                                            <div class="w-20 h-20 bg-[#1a1a1a] rounded-full flex items-center justify-center border-4 border-[#d4c5a5] mx-auto shadow-lg">
                                                <i data-lucide="target" class="text-[#d4c5a5] w-11 h-11"></i>
                                            </div>
                                            
                                            <div class="space-y-2">
                                                <h2 class="text-3xl font-black text-[#1a1a1a] font-typewriter uppercase">أنت الشاهد</h2>
                                                <p class="text-[#8b0000] text-sm font-bold">تعرف الكلمة السرية 🎯</p>
                                            </div>

                                            <div class="bg-gradient-to-br from-[#f0e6d2] to-[#e6dcc5] border-2 border-[#1a1a1a] rounded-lg p-4">
                                                <p class="text-[10px] text-gray-600 font-typewriter uppercase tracking-wider mb-2 font-bold">الكلمة السرية:</p>
                                                <div class="text-4xl font-black text-[#8b0000] font-typewriter tracking-wider border-y-2 border-[#1a1a1a] py-3 bg-white/50 rounded">
                                                    ${state.secretWord}
                                                </div>
                                            </div>

                                            <div class="bg-[#1a1a1a]/10 border-2 border-[#1a1a1a] rounded-lg p-3 text-xs text-[#1a1a1a] font-typewriter space-y-1 text-left">
                                                <p class="font-bold uppercase mb-1">مهمتك:</p>
                                                <div class="space-y-0.5">
                                                    <p>▸ اطرح أسئلة ذكية</p>
                                                    <p>▸ ركّز على الأجوبة المريبة</p>
                                                    <p>▸ اكتشف المخادع 🔍</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `}
                        
                        <button onclick="handleNextPlayerWithAnimation()" class="noir-btn btn-primary w-full py-3 text-sm font-bold hover:scale-105 active:scale-95 transition-transform shadow-lg">
                            <i data-lucide="arrow-right" class="w-4 h-4 ml-2"></i>
                            ${state.currentPlayerIndex < state.players.length - 1 ? 'التالي' : 'ابدأ التحقيق'}
                        </button>
                    </div>

                </div>
            `;

            // Initialize Scanner Logic
            const btn = document.getElementById('scanBtn');
            const scanLine = document.getElementById('scanLine');
            const fingerIcon = document.getElementById('fingerIcon');
            const scanText = document.getElementById('scanText');
            let interval;
            let progress = 0;

            const startScan = (e) => {
                e.preventDefault();
                clearInterval(interval);
                interval = setInterval(() => {
                    progress += 4;
                    scanLine.style.width = `${progress}%`;
                    fingerIcon.classList.add('text-[#f0e6d2]', 'scale-110');
                    fingerIcon.classList.remove('text-[#d4c5a5]');
                    scanText.innerText = "جاري الفحص البيومتري...";
                    
                    if (progress >= 100) {
                        clearInterval(interval);
                        if (navigator.vibrate) navigator.vibrate(50);
                        document.getElementById('passStateIdle').classList.add('hidden');
                        document.getElementById('passStateRevealed').classList.remove('hidden');
                        document.getElementById('passStateRevealed').classList.add('flex');
                    }
                }, 20);
            };

            const stopScan = () => {
                clearInterval(interval);
                progress = 0;
                scanLine.style.width = '0%';
                fingerIcon.classList.remove('text-[#f0e6d2]', 'scale-110');
                fingerIcon.classList.add('text-[#d4c5a5]');
                scanText.innerText = "اضغط مطولاً للكشف";
            };

            btn.addEventListener('mousedown', startScan);
            btn.addEventListener('mouseup', stopScan);
            btn.addEventListener('mouseleave', stopScan);
            btn.addEventListener('touchstart', startScan);
            btn.addEventListener('touchend', stopScan);
        }

        function renderPlaying(container) {
            // Question Logic - Compact Mobile Design
            let questionHtml = '';
            if (state.questionState.showTransition) {
                questionHtml = `
                    <div class="flex items-center justify-center flex-col gap-2">
                        <i data-lucide="hourglass" class="w-12 h-12 text-[#d4c5a5] animate-spin"></i>
                        <h3 class="text-xl font-bold text-[#d4c5a5] font-typewriter">جهّز نفسك</h3>
                    </div>
                `;
            } else if (state.questionState.isCustom) {
                questionHtml = `
                    <div class="w-full">
                        <div class="bg-gradient-to-br from-[#1a1a1a] to-[#0a0a0a] border border-white/5 rounded-xl p-6 shadow-lg text-center space-y-4">
                            <div class="flex justify-center mb-2">
                                <i data-lucide="users" class="w-10 h-10 text-[#8b0000]"></i>
                            </div>
                            
                            <div>
                                <h3 class="text-xl font-bold text-[#d4c5a5] font-typewriter mb-1">نقاش حر</h3>
                                <p class="text-xs text-[#8b0000] font-semibold">الجميع يتحدثون</p>
                            </div>
                            
                            <div class="border-t border-b border-white/5 py-3 my-2">
                                <p class="text-sm text-[#f0e6d2]">استجواب حر - ناقش مع الآخرين واكتشف الحقيقة!</p>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-3 pt-2">
                                <div class="bg-[#8b0000] bg-opacity-20 border border-white/5 rounded-lg p-3">
                                    <div class="text-lg font-bold text-[#d4c5a5]">${state.settings.timerDuration}ث</div>
                                    <p class="text-xs text-[#f0e6d2]">الوقت</p>
                                </div>
                                <div class="bg-[#8b0000] bg-opacity-20 border border-white/5 rounded-lg p-3">
                                    <div class="text-lg font-bold text-[#d4c5a5]">${state.players.length}</div>
                                    <p class="text-xs text-[#f0e6d2]">مشاركين</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                const asker = state.players[state.questionState.askerIndex];
                const targetIndex = (state.questionState.askerIndex + 1) % state.players.length;
                const target = state.players[targetIndex];
                questionHtml = `
                    <div class="w-full space-y-3">
                        <!-- Asker Card -->
                        <div class="relative w-full">
                            <div class="relative bg-gradient-to-br from-[#1a1a1a] to-[#0a0a0a] border-2 border-[#d4c5a5] rounded-xl p-4 shadow-lg">
                                <div class="absolute -top-3 left-1/2 -translate-x-1/2 bg-[#8b0000] text-[#f0e6d2] px-3 py-0.5 rounded-full text-[10px] font-bold font-typewriter border border-[#d4c5a5]">السائل</div>
                                <div class="flex items-center justify-center gap-3 pt-1">
                                    <div class="w-10 h-10 bg-[#8b0000] rounded-full flex items-center justify-center shadow-lg border border-[#d4c5a5]">
                                        <i data-lucide="help-circle" class="w-5 h-5 text-[#f0e6d2]"></i>
                                    </div>
                                    <h4 class="text-base font-bold text-[#d4c5a5] font-typewriter break-words flex-1">${asker}</h4>
                                </div>
                            </div>
                        </div>

                        <!-- Arrow Connection -->
                        <div class="flex justify-center">
                            <i data-lucide="arrow-down" class="w-5 h-5 text-[#d4c5a5] animate-bounce"></i>
                        </div>

                        <!-- Target Card -->
                        <div class="relative w-full">
                            <div class="relative bg-[#f0e6d2] border-2 border-[#1a1a1a] rounded-xl p-4 shadow-lg">
                                <div class="absolute -top-3 left-1/2 -translate-x-1/2 bg-[#1a1a1a] text-[#f0e6d2] px-3 py-0.5 rounded-full text-[10px] font-bold font-typewriter border border-[#d4c5a5]">المجيب</div>
                                <div class="flex items-center justify-center gap-3 pt-1">
                                    <div class="w-10 h-10 bg-[#1a1a1a] rounded-full flex items-center justify-center shadow-lg border border-[#d4c5a5]">
                                        <i data-lucide="message-square" class="w-5 h-5 text-[#d4c5a5]"></i>
                                    </div>
                                    <h4 class="text-base font-bold text-[#1a1a1a] font-typewriter break-words flex-1">${target}</h4>
                                </div>
                            </div>
                        </div>

                        <!-- Round Info -->
                        <div class="flex justify-center gap-3 items-center py-2 border-t border-[#333]">
                            <div class="text-center">
                                <div class="text-[9px] text-gray-500 uppercase font-typewriter">الجولة</div>
                                <div class="text-lg font-bold text-[#d4c5a5] font-typewriter">${state.questionState.round}/${state.settings.roundsPerPlayer}</div>
                            </div>
                        </div>

                        <!-- Next Question Button -->
                        <button onclick="nextQuestion()" class="relative w-full py-3 px-4 text-sm font-bold text-[#1a1a1a] bg-gradient-to-br from-[#d4c5a5] to-[#c4b295] border-2 border-[#8b0000] rounded-lg shadow-lg hover:shadow-2xl hover:scale-105 active:scale-95 transition-all duration-300 overflow-hidden group">
                            <div class="absolute inset-0 bg-gradient-to-r from-transparent via-white to-transparent opacity-0 group-hover:opacity-20 transition-opacity"></div>
                            <div class="relative z-10 flex items-center justify-center gap-2">
                                <span>السؤال التالي</span>
                                <i data-lucide="arrow-right" class="w-4 h-4 transition-transform group-hover:translate-x-1"></i>
                            </div>
                        </button>
                    </div>
                `;
            }

            container.innerHTML = `
                <div class="h-full flex flex-col justify-between py-4">
                    <div class="flex-1 flex flex-col justify-center px-2">
                        ${questionHtml}
                    </div>

                    <!-- Bottom Section -->
                    <div class="space-y-2 border-t border-[#333] pt-3 px-2">
                        <div class="grid grid-cols-2 gap-3 text-center text-[10px]">
                            <div class="bg-[#1a1a1a] border border-[#333] rounded p-2">
                                <div class="text-gray-500 uppercase font-typewriter mb-0.5">الزمن</div>
                                <div class="text-lg font-bold text-[#d4c5a5] font-typewriter tabular-nums" id="gameTimer">${formatTime(state.timer)}</div>
                            </div>
                            <div class="bg-[#1a1a1a] border border-[#333] rounded p-2">
                                <div class="text-gray-500 uppercase font-typewriter mb-0.5">موقع</div>
                                <div class="text-xs font-bold text-[#d4c5a5] font-typewriter truncate">${state.selectedCategory}</div>
                            </div>
                        </div>
                        <button onclick="setState('voting')" class="noir-btn btn-danger w-full text-sm py-2">
                            <i data-lucide="gavel" class="w-4 h-4"></i> تصويت
                        </button>
                    </div>
                </div>
            `;
        }

        function renderVoting(container) {
            // Phase 1: Pass Phone
            if (state.votingState.phase === 'pass') {
                const currentVoter = state.players[state.votingState.currentVoterIndex];
                container.innerHTML = `
                    <div class="h-full flex flex-col items-center justify-center text-center gap-6 animate-slide-up">
                        <div class="w-20 h-20 bg-[#f0e6d2] rounded-full flex items-center justify-center border-4 border-[#8b0000] shadow-[0_0_20px_rgba(139,0,0,0.3)]">
                            <i data-lucide="user-check" class="text-[#8b0000] w-10 h-10"></i>
                        </div>
                        <div>
                            <p class="text-gray-500 text-sm font-typewriter mb-2">دور التصويت</p>
                            <h2 class="text-3xl font-bold text-[#f0e6d2]">${currentVoter}</h2>
                        </div>
                        <p class="text-xs text-gray-400 max-w-[200px]">مرر الجهاز إلى ${currentVoter} ليقوم بالتصويت بسرية</p>
                        
                        <button onclick="startVotingTurn()" class="noir-btn btn-primary mt-8">
                            أنا ${currentVoter} (ابدأ التصويت)
                        </button>
                    </div>
                `;
                return;
            }

            // Phase 2: Vote
            const currentVoterIndex = state.votingState.currentVoterIndex;
            
            const playersHtml = state.players.map((p, i) => {
                if (i === currentVoterIndex) return ''; // Cannot vote for self
                
                return `
                <button onclick="handleVote(${i})" class="relative h-32 bg-[#e6dcc5] text-black group hover:bg-[#fff] shadow-md transition-all border p-2 flex flex-col items-center justify-center gap-2 overflow-hidden">
                    <div class="absolute -top-3 left-1/2 -translate-x-1/2 w-12 h-4 bg-white/40 border-l border-r border-white/60 blur-[0.5px]"></div>
                    
                    <div class="w-12 h-12 bg-gray-300 border border-gray-400 flex items-center justify-center group-hover:grayscale-0 grayscale transition-all mb-1">
                        <span class="font-bold text-xl opacity-50 text-black">?</span>
                    </div>
                    
                    <span class="font-bold font-typewriter text-sm uppercase">${p}</span>

                    <!-- Hover Effect -->
                    <div class="absolute inset-0 bg-[#8b0000] opacity-0 group-active:opacity-90 transition-opacity flex items-center justify-center">
                        <span class="text-white font-bold uppercase border-2 border-white px-2 py-1 transform -rotate-12">تصويت</span>
                    </div>
                </button>
            `}).join('');

            container.innerHTML = `
                <div class="h-full flex flex-col animate-slide-up">
                    <div class="text-center mb-8">
                        <div class="text-xs text-gray-500 mb-2">المصوت: <span class="text-[#f0e6d2]">${state.players[currentVoterIndex]}</span></div>
                        <h2 class="text-xl font-typewriter font-bold text-[#8b0000] uppercase tracking-widest bg-[#f0e6d2] inline-block px-4 py-2 transform rotate-1 shadow-[4px_4px_0_rgba(0,0,0,0.5)] border border-black">
                            من هو المخادع؟
                        </h2>
                        <p class="text-gray-500 text-xs mt-4 font-typewriter">اضغط على صورة المشتبه به للتصويت</p>
                    </div>

                    <div class="grid grid-cols-2 gap-4 pb-4 overflow-y-auto custom-scrollbar">
                        ${playersHtml}
                    </div>
                </div>
            `;
        }

        function renderResult(container) {
            const isCitizensWin = state.winner === 'citizens';
            
            container.innerHTML = `
                <div class="h-full flex flex-col items-center justify-center text-center gap-8 animate-slide-up relative z-20">
                    <div class="case-file w-full transform rotate-1 case-folder relative">
                        <div class="paper-clip"></div>
                        <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 border-4 ${isCitizensWin ? 'border-green-800 text-green-800' : 'border-[#8b0000] text-[#8b0000]'} px-6 py-2 text-4xl font-black font-typewriter -rotate-12 opacity-0 stamp-animation pointer-events-none whitespace-nowrap z-30 mix-blend-multiply">
                            ${isCitizensWin ? 'SOLVED' : 'COLD CASE'}
                        </div>

                        <div class="flex flex-col items-center gap-8 py-4">
                            <div class="p-4 border-4 rounded-full ${isCitizensWin ? 'border-green-800 text-green-800' : 'border-[#8b0000] text-[#8b0000]'}">
                                <i data-lucide="${isCitizensWin ? 'check' : 'eye-off'}" class="w-12 h-12"></i>
                            </div>
                            
                            <div class="relative">
                                <h2 class="text-3xl font-black font-typewriter uppercase mb-2 ${isCitizensWin ? 'text-green-900' : 'text-[#8b0000]'}">
                                    ${isCitizensWin ? 'تم حل القضية' : 'الجاني هرب'}
                                </h2>
                                <div class="w-full h-1 bg-black/10 mx-auto"></div>
                            </div>

                            <div class="w-full bg-white/40 p-5 border border-gray-400 font-typewriter text-sm space-y-3 text-left shadow-inner">
                                <div class="flex justify-between border-b border-gray-300 pb-2 border-dashed">
                                    <span class="text-gray-600 uppercase tracking-wider">المخادع:</span>
                                    <span class="font-bold text-[#8b0000] text-lg">${state.players[state.imposterIndex]}</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-gray-600 uppercase tracking-wider">الكلمة:</span>
                                    <span class="font-bold text-black text-xl bg-[#ffff00]/30 px-2">${state.secretWord}</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="w-full flex flex-col gap-3">
                        <button onclick="restartGame()" class="noir-btn btn-primary py-4 w-full">
                            <i data-lucide="search" class="w-5 h-5"></i> قضية جديدة
                        </button>
                        <button onclick="resetGame()" class="noir-btn btn-ghost w-full">
                            العودة للأرشيف
                        </button>
                    </div>
                </div>
            `;
        }

        // --- ACTIONS ---

        function setState(screen) {
            state.screen = screen;
            render();
        }

        function resetPoints() {
            if (confirm("هل أنت متأكد من تصفير جميع النقاط؟")) {
                state.scores = {};
                render();
            }
        }

        function addPlayer() {
            const input = document.getElementById('newPlayerInput');
            const name = input.value.trim();
            if (name && !state.players.includes(name)) {
                state.players.push(name);
                if (!state.scores[name]) state.scores[name] = 0; // Init score
                render();
                // Keep focus
                setTimeout(() => document.getElementById('newPlayerInput')?.focus(), 10);
            }
        }

        function removePlayer(index) {
            state.players.splice(index, 1);
            render();
        }

        function handleEnter(e) {
            if (e.key === 'Enter') addPlayer();
        }

        function goToCategory() {
            if (state.players.length < 3) return;
            
            // Delay to show button animation on mobile
            setTimeout(() => {
                // Create Transition
                const transDiv = document.createElement('div');
                transDiv.className = 'transition-overlay';
                document.body.appendChild(transDiv);

                // Wait for animation then switch
                setTimeout(() => {
                    setState('category');
                }, 300);
                
                setTimeout(() => transDiv.remove(), 600);
            }, 200);
        }

        function handleBackToSetup() {
            // Create Transition Overlay (Reverse slide)
            const transDiv = document.createElement('div');
            transDiv.className = 'transition-overlay reverse';
            document.body.appendChild(transDiv);

            // Wait for animation then switch
            setTimeout(() => {
                setState('setup');
            }, 300);
            
            setTimeout(() => transDiv.remove(), 600);
        }

        function startGame(category) {
            let words = CATEGORIES[category];
            if (category === 'عشوائي') {
                const keys = Object.keys(CATEGORIES).filter(k => k !== 'عشوائي');
                words = CATEGORIES[keys[Math.floor(Math.random() * keys.length)]];
                category = 'عشوائي'; // Keep label as random or change? User expects random.
            }
            
            // Create Noir Animation Overlay
            const overlay = document.createElement('div');
            overlay.className = 'noir-overlay';
            overlay.innerHTML = `
                <div class="noir-panel left"></div>
                <div class="noir-panel right"></div>
                <div class="noir-content">
                    <div class="relative mb-6">
                        <i data-lucide="folder-search" class="w-24 h-24 text-[#f0e6d2]"></i>
                        <div class="absolute -bottom-2 -right-2 bg-[#8b0000] text-white text-xs px-2 py-1 font-bold font-typewriter transform -rotate-6 shadow-lg border border-black">CONFIDENTIAL</div>
                    </div>
                    <h2 class="text-3xl font-bold font-typewriter text-[#f0e6d2] tracking-widest uppercase mb-4 drop-shadow-md">${category}</h2>
                    <div class="text-[#8b0000] font-bold border-4 border-[#8b0000] px-6 py-2 text-lg tracking-widest opacity-0" id="loadingStamp">جاري بدء التحقيق</div>
                </div>
            `;
            document.body.appendChild(overlay);
            lucide.createIcons();

            // Trigger Animation Sequence
            requestAnimationFrame(() => overlay.classList.add('active'));
            setTimeout(() => overlay.querySelector('.noir-content').classList.add('visible'), 500);
            setTimeout(() => {
                const stamp = document.getElementById('loadingStamp');
                if(stamp) {
                    stamp.classList.remove('opacity-0');
                    stamp.classList.add('stamp-slam');
                    if (navigator.vibrate) navigator.vibrate(50);
                }
            }, 1000);

            setTimeout(() => {
                const secretWord = words[Math.floor(Math.random() * words.length)];
                const imposterIndex = Math.floor(Math.random() * state.players.length);
                const firstPlayerIndex = Math.floor(Math.random() * state.players.length);

                state.selectedCategory = category;
                state.secretWord = secretWord;
                state.imposterIndex = imposterIndex;
                state.firstPlayerIndex = firstPlayerIndex;
                state.currentPlayerIndex = 0;
                state.timer = 0;
                state.questionState = { round: 1, askerIndex: firstPlayerIndex, isCustom: false, showTransition: false };
                
                setState('pass-phone');
                
                // Exit Animation
                overlay.querySelector('.noir-content').classList.remove('visible');
                overlay.classList.remove('active');
                
                setTimeout(() => overlay.remove(), 600);
            }, 2200);
        }

        function handleCustomGame() {
            const nameInput = document.getElementById('customName');
            const input = document.getElementById('customWords');
            const val = input.value;
            const name = nameInput.value.trim();
            const words = val.split(/,|،|\n/).map(w => w.trim()).filter(w => w.length > 0);
            
            if (words.length < 2) {
                alert('الرجاء إدخال كلمتين على الأقل للمتابعة.');
                return;
            }
            
            state.customCategoryName = name || 'ملف مخصص';

            // Temporary override categories for this game
            const categoryName = state.customCategoryName;
            CATEGORIES[categoryName] = words;
            startGame(categoryName);
        }

        function handleNextPlayerWithAnimation() {
            // Create transition animation overlay
            const overlay = document.createElement('div');
            overlay.className = 'transition-overlay';
            document.body.appendChild(overlay);

            setTimeout(() => {
                handleNextPlayer();
                setTimeout(() => overlay.remove(), 300);
            }, 300);
        }

        function handleNextPlayer() {
            if (state.currentPlayerIndex + 1 < state.players.length) {
                state.currentPlayerIndex++;
                setState('pass-phone');
            } else {
                startTimer();
                setState('playing');
            }
        }

        function nextQuestion() {
            // Show transition animation
            state.questionState.showTransition = true;
            render();

            setTimeout(() => {
                // Logic: Asker asks Next person.
                state.questionState.askerIndex = (state.questionState.askerIndex + 1) % state.players.length;
                
                // Check if we completed a full circle (round)
                if (state.questionState.askerIndex === state.firstPlayerIndex) {
                    state.questionState.round++;
                }

                // Check if we exceeded max rounds
                if (state.questionState.round > state.settings.roundsPerPlayer) {
                    state.questionState.isCustom = true;
                }
                
                state.questionState.showTransition = false;
                render();
            }, 1000);
        }

        function startTimer() {
            if (state.timerInterval) clearInterval(state.timerInterval);
            state.timer = 0;
            state.timerInterval = setInterval(() => {
                state.timer++;
                const el = document.getElementById('gameTimer');
                if (el) el.innerText = formatTime(state.timer);
                
                // Auto stop at limit? Optional.
                if (state.timer >= state.settings.timerDuration && !state.questionState.isCustom) {
                     // Maybe visual alert?
                     document.getElementById('gameTimer').classList.add('text-red-500');
                }
            }, 1000);
        }

        function startVotingTurn() {
            state.votingState.phase = 'vote';
            render();
        }

        function handleVote(suspectIndex) {
            // Record vote
            const currentVoter = state.players[state.votingState.currentVoterIndex];
            state.votingState.votes[currentVoter] = suspectIndex;

            // Next voter
            state.votingState.currentVoterIndex++;
            state.votingState.phase = 'pass';

            if (state.votingState.currentVoterIndex >= state.players.length) {
                finishVoting();
            } else {
                render();
            }
        }

        function finishVoting() {
            clearInterval(state.timerInterval);
            
            // Tally votes
            const voteCounts = {};
            Object.values(state.votingState.votes).forEach(targetIndex => {
                voteCounts[targetIndex] = (voteCounts[targetIndex] || 0) + 1;
            });

            // Find max votes
            let maxVotes = 0;
            let mostVotedIndex = null;
            for (const [index, count] of Object.entries(voteCounts)) {
                if (count > maxVotes) {
                    maxVotes = count;
                    mostVotedIndex = parseInt(index);
                } else if (count === maxVotes) {
                    mostVotedIndex = -1; // Tie
                }
            }

            // Determine Winner & Points
            const imposterCaught = (mostVotedIndex === state.imposterIndex);
            
            if (imposterCaught) {
                state.winner = 'citizens';
            } else {
                state.winner = 'imposter';
            }

            // Distribute Points
            state.players.forEach((p, i) => {
                let pointsToAdd = 0;
                if (i === state.imposterIndex) {
                    // Rule 2: Imposter gets 10 points if wins, 0 if loses
                    if (!imposterCaught) {
                        pointsToAdd = 10;
                    }
                } else {
                    // Rule 1: Winner (Citizens) gets 10 points
                    if (imposterCaught) {
                        pointsToAdd += 10;
                    }
                    // Rule 3: Correct vote gets 5 points (does not apply to imposter)
                    if (state.votingState.votes[p] === state.imposterIndex) {
                        pointsToAdd += 5;
                    }
                }
                
                // Cap points at 10 per round
                if (pointsToAdd > 10) pointsToAdd = 10;
                
                state.scores[p] = (state.scores[p] || 0) + pointsToAdd;
            });

            setState('result');
        }

        function restartGame() {
            // Keep players, reset round
            startGame(state.selectedCategory === 'ملف مخصص' ? 'ملف مخصص' : state.selectedCategory); 
            // Note: If custom words were not saved in state properly for replay, this might need adjustment. 
            // For simplicity, we re-use if valid, or just go to category select if complex.
            // Let's actually go to category select to be safe.
            if (state.selectedCategory === 'ملف مخصص') {
                 // If we want to replay custom, we need to persist the words. 
                 // For now, let's just go back to category to keep it simple.
                 setState('category');
            } else {
                 startGame(state.selectedCategory);
            }
        }

        function resetGame() {
            clearInterval(state.timerInterval);
            state.screen = 'setup';
            state.timer = 0;
            state.votingState = { currentVoterIndex: 0, votes: {}, phase: 'pass' };
            render();
        }

        // --- UTILS ---
        function formatTime(s) {
            const mins = Math.floor(s / 60);
            const secs = s % 60;
            return `${mins}:${secs < 10 ? '0' : ''}${secs}`;
        }

        function showRules() {
            document.getElementById('rulesModal').classList.remove('hidden');
        }

        function closeRules() {
            setTimeout(() => {
                document.getElementById('rulesModal').classList.add('hidden');
            }, 200);
        }

        function toggleSettings(show) {
            const modal = document.getElementById('settingsModal');
            if (show) modal.classList.remove('hidden');
            else modal.classList.add('hidden');
        }

        function showExitConfirm() {
            document.getElementById('exitModal').classList.remove('hidden');
        }

        function closeExitConfirm() {
            document.getElementById('exitModal').classList.add('hidden');
        }

        function confirmExit() {
            closeExitConfirm();
            resetGame();
        }

        function saveSettings() {
            const timer = parseInt(document.getElementById('settingTimer').value) || 60;
            const rounds = parseInt(document.getElementById('settingRounds').value) || 3;
            
            setTimeout(() => {
                state.settings.timerDuration = timer;
                state.settings.roundsPerPlayer = rounds;
                toggleSettings(false);
            }, 200);
        }

        // --- INIT ---
        render();

        // --- START INVESTIGATION ---
        function startInvestigation() {
            const overlay = document.getElementById('splash-overlay');
            const button = overlay?.querySelector('.start-button');
            const mainContent = document.getElementById('main-content');
            
            if (button) {
                button.classList.add('clicked');
            }
            
            if (overlay) {
                overlay.classList.add('hidden');
                
                // Show main content after overlay animation
                if (mainContent) {
                    setTimeout(() => {
                        mainContent.classList.remove('opacity-0');
                    }, 1000);
                    mainContent.classList.remove('opacity-0');
                }
                
                // Remove overlay from DOM
                setTimeout(() => {
                    if (overlay && overlay.parentNode) overlay.remove();
                }, 1000);
            }
        }

        // --- SPLASH SCREEN LINES ANIMATION ---
        function createSplashLines() {
            const container = document.getElementById('splashLines');
            if (!container) return;
            
            const lineCount = 6;
            for (let i = 0; i < lineCount; i++) {
                const line = document.createElement('div');
                line.className = 'splash-line';
                line.style.width = '100%';
                line.style.height = '2px';
                line.style.top = `${(i / lineCount) * 100}%`;
                line.style.animationDelay = `${i * 0.3}s`;
                line.style.animationDuration = `${3 + (i * 0.1)}s`;
                container.appendChild(line);
            }
        }

        // --- SPLASH SCREEN LOGIC ---
        window.addEventListener('load', () => {
            createSplashLines();
            setTimeout(() => {
                const splash = document.getElementById('splash-screen');
                const mainContent = document.getElementById('main-content');
                if(splash) {
                    if(mainContent) {
                        mainContent.classList.remove('opacity-0');
                    }
                    setTimeout(() => {
                        if(splash && splash.parentNode) splash.remove(); // Remove from DOM after fade-out
                    }, 1000);
                }
            }, 3000); // Show for exactly 3 seconds
        });
    </script>
</body>
</html>
